<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1a2744" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MUAI Prayer" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icon-192.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="/icon-192.svg" />
  <title>MUAI Prayer Times — Birmingham</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap');

    :root {
      --navy: #1a2744;
      --navy-light: #263a5e;
      --navy-deep: #0f1a30;
      --gold: #b8962e;
      --gold-light: #d4af37;
      --gold-soft: #f5ecd7;
      --bg: #fafafa;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-muted: #888;
      --text-light: #bbb;
      --border: #eee;
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
      --shadow-lg: 0 2px 8px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', -apple-system, 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Navy header ── */
    .hero {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-deep) 50%, var(--navy) 100%);
      color: white;
      text-align: center;
      padding: 36px 20px 56px;
      position: relative;
      overflow: hidden;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(184,150,46,0.06) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(184,150,46,0.04) 0%, transparent 50%);
      pointer-events: none;
    }

    .hero::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      opacity: 0.03;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(255,255,255,0.5) 28px, rgba(255,255,255,0.5) 29px),
        repeating-linear-gradient(90deg, transparent, transparent 28px, rgba(255,255,255,0.5) 28px, rgba(255,255,255,0.5) 29px);
      pointer-events: none;
    }

    .hero-content { position: relative; z-index: 1; }

    .mosque-svg {
      margin-bottom: 10px;
    }

    .mosque-svg svg {
      width: 52px;
      height: 52px;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.2));
    }

    .hero h1 {
      font-family: 'Amiri', serif;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 2px;
    }

    .hero h1 span { color: var(--gold-light); }

    .hero-subtitle {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.5);
      font-weight: 300;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .hero-date {
      margin-top: 14px;
      font-size: 0.82rem;
      color: rgba(255,255,255,0.7);
      font-weight: 400;
    }

    /* ── Arch divider ── */
    .arch-divider {
      position: relative;
      margin-top: -30px;
      text-align: center;
      z-index: 2;
    }

    .arch-divider svg { display: block; width: 100%; height: 30px; }

    /* ── Countdown banner ── */
    .countdown-wrap {
      max-width: 480px;
      margin: -14px auto 0;
      padding: 0 16px;
      position: relative;
      z-index: 3;
    }

    .countdown {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 24px;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }

    .countdown-label {
      font-size: 0.68rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .countdown-prayer {
      font-family: 'Amiri', serif;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
    }

    .countdown-at {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 4px;
    }

    .countdown-time {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gold);
      letter-spacing: 0.04em;
      font-variant-numeric: tabular-nums;
    }

    .countdown-remaining-label {
      font-size: 0.62rem;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-top: 2px;
    }

    .countdown-jamat-row {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .countdown-jamat-row.visible { display: block; }
    .countdown-jamat-label {
      font-size: 0.62rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 2px;
    }
    .countdown-jamat-time {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--navy);
      font-variant-numeric: tabular-nums;
    }
    .countdown-jamat-at {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    /* ── Jamat toggle ── */
    .jamat-toggle-wrap {
      max-width: 480px;
      margin: 10px auto 0;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }
    .jamat-toggle-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      flex-shrink: 0;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--border);
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 16px; height: 16px;
      left: 2px; bottom: 2px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    .toggle-switch input:checked + .toggle-slider {
      background: var(--navy);
    }
    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(16px);
    }

    /* ── Prayer list ── */
    .prayer-section {
      max-width: 480px;
      margin: 24px auto 0;
      padding: 0 16px 16px;
    }

    .section-label {
      font-size: 0.68rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
      margin-bottom: 10px;
      padding-left: 4px;
    }

    .prayer-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .prayer-row {
      display: flex;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid #f3f3f3;
      transition: background 0.15s;
    }

    .prayer-row:last-child { border-bottom: none; }

    .prayer-row.active {
      background: linear-gradient(135deg, #eef2f9 0%, #f6f8fc 100%);
      border-left: 3px solid var(--navy);
      padding-left: 15px;
    }

    .prayer-row.past { opacity: 0.4; }

    .prayer-icon {
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: #f5f5f5;
      flex-shrink: 0;
    }

    .prayer-icon svg {
      width: 20px;
      height: 20px;
    }

    .prayer-row.active .prayer-icon {
      background: #dde4f0;
    }

    .prayer-info {
      flex: 1;
      margin-left: 12px;
    }

    .prayer-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    .prayer-jamat {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .prayer-time-col {
      text-align: right;
      flex-shrink: 0;
    }

    .prayer-adhan-time {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }

    .prayer-jamat-time {
      font-size: 0.68rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .prayer-row.active .prayer-adhan-time {
      color: var(--navy);
    }

    /* ── Calendar panel ── */
    .calendar-section {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 16px 32px;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      border: 1px solid var(--navy-light);
      border-radius: 12px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      margin-bottom: 8px;
    }

    .calendar-nav button {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 1.1rem;
      transition: all 0.12s;
    }

    .calendar-nav button:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.25);
    }

    .calendar-nav button:disabled {
      opacity: 0.2;
      cursor: not-allowed;
    }

    .calendar-nav-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: white;
      text-align: center;
    }

    .calendar-nav-sub {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.55);
      font-weight: 400;
    }

    .calendar-day-list {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .cal-prayer-row {
      display: grid;
      grid-template-columns: 1fr 80px 90px;
      align-items: center;
      padding: 11px 18px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.82rem;
      transition: background 0.12s;
    }

    .cal-prayer-row:last-child { border-bottom: none; }

    .cal-prayer-row:hover { background: #fafbfd; }

    .cal-prayer-icon {
      width: 22px;
      height: 22px;
      display: inline-flex;
      vertical-align: middle;
      margin-right: 8px;
    }

    .cal-prayer-icon svg {
      width: 18px;
      height: 18px;
    }

    .cal-prayer-name {
      font-weight: 500;
      color: var(--text);
      display: flex;
      align-items: center;
    }

    .cal-prayer-time {
      font-weight: 600;
      color: var(--navy);
      font-variant-numeric: tabular-nums;
      text-align: right;
    }

    .cal-prayer-jamat {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    /* ── No data state ── */
    .no-data {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .no-data-icon { font-size: 2rem; margin-bottom: 8px; opacity: 0.4; }

    /* ── Install banner ── */
    .install-banner {
      display: none;
      max-width: 480px;
      margin: 0 auto 12px;
      padding: 0 16px;
    }

    .install-banner.show { display: block; }

    .install-inner {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      border-radius: 12px;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow);
    }

    .install-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.12);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .install-icon svg { width: 22px; height: 22px; }

    .install-text {
      flex: 1;
      color: white;
      font-size: 0.78rem;
      line-height: 1.4;
    }

    .install-text strong { font-weight: 600; }

    .install-btn {
      background: var(--gold);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 0.72rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .install-dismiss {
      background: none;
      border: none;
      color: rgba(255,255,255,0.4);
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0 2px;
      flex-shrink: 0;
    }

    /* ── Footer ── */
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.65rem;
      color: var(--text-light);
      letter-spacing: 0.04em;
    }

    /* ── Loading pulse ── */
    .loading .prayer-row {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
  </style>
</head>
<body>

<div class="hero">
  <div class="hero-content">
    <div class="mosque-svg">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 4C32 4 22 14 22 20V24H18V20C18 18 16 16 14 16C12 16 10 18 10 20V24H8V44H56V24H54V20C54 18 52 16 50 16C48 16 46 18 46 20V24H42V20C42 14 32 4 32 4Z" fill="rgba(255,255,255,0.9)"/>
        <rect x="8" y="44" width="48" height="4" rx="1" fill="rgba(255,255,255,0.7)"/>
        <rect x="28" y="30" width="8" height="14" rx="4" fill="rgba(26,39,68,0.4)"/>
        <circle cx="14" cy="14" r="2" fill="rgba(212,175,55,0.6)"/>
        <circle cx="50" cy="14" r="2" fill="rgba(212,175,55,0.6)"/>
        <circle cx="32" cy="2" r="1.5" fill="rgba(212,175,55,0.7)"/>
        <rect x="4" y="48" width="56" height="12" rx="2" fill="rgba(255,255,255,0.15)"/>
      </svg>
    </div>
    <h1><span>MUAI</span> Prayer Times</h1>
    <div class="hero-subtitle">Birmingham, UK</div>
    <div class="hero-date" id="hero-date">&mdash;</div>
  </div>
</div>

<div class="arch-divider">
  <svg viewBox="0 0 400 30" preserveAspectRatio="none">
    <path d="M0,0 L0,30 L400,30 L400,0 C400,0 350,28 200,28 C50,28 0,0 0,0 Z" fill="#fafafa"/>
  </svg>
</div>

<div class="countdown-wrap">
  <div class="countdown" id="countdown-box">
    <div class="countdown-label">Next prayer</div>
    <div class="countdown-prayer" id="cd-prayer">&mdash;</div>
    <div class="countdown-at" id="cd-at">&mdash;</div>
    <div class="countdown-time" id="cd-time">&mdash;</div>
    <div class="countdown-remaining-label" id="cd-remaining-label">remaining</div>
    <div class="countdown-jamat-row" id="cd-jamat-row">
      <div class="countdown-jamat-label">Jama'ah in</div>
      <div class="countdown-jamat-time" id="cd-jamat-time">&mdash;</div>
      <div class="countdown-jamat-at" id="cd-jamat-at"></div>
    </div>
  </div>
</div>

<div class="jamat-toggle-wrap">
  <span class="jamat-toggle-label">Show Jama'ah countdown</span>
  <label class="toggle-switch">
    <input type="checkbox" id="jamat-toggle" />
    <span class="toggle-slider"></span>
  </label>
</div>

<div class="prayer-section">
  <div class="section-label" id="prayers-label">Today's prayers</div>
  <div class="prayer-card loading" id="prayer-list">
    <div class="prayer-row"><div class="prayer-icon" style="background:#f0f0f0">&nbsp;</div><div class="prayer-info" style="margin-left:14px"><div style="background:#f0f0f0;height:12px;width:60px;border-radius:4px"></div></div></div>
    <div class="prayer-row"><div class="prayer-icon" style="background:#f0f0f0">&nbsp;</div><div class="prayer-info" style="margin-left:14px"><div style="background:#f0f0f0;height:12px;width:60px;border-radius:4px"></div></div></div>
    <div class="prayer-row"><div class="prayer-icon" style="background:#f0f0f0">&nbsp;</div><div class="prayer-info" style="margin-left:14px"><div style="background:#f0f0f0;height:12px;width:60px;border-radius:4px"></div></div></div>
  </div>
</div>

<div class="calendar-section" id="calendar-section" style="display:none;">
  <div class="section-label">Schedule</div>
  <div class="calendar-nav">
    <button id="cal-prev" title="Previous day">&#8249;</button>
    <div style="text-align:center">
      <div class="calendar-nav-label" id="cal-label">&mdash;</div>
      <div class="calendar-nav-sub" id="cal-sub">&mdash;</div>
    </div>
    <button id="cal-next" title="Next day">&#8250;</button>
  </div>
  <div class="calendar-day-list" id="cal-list"></div>
</div>

<div class="install-banner" id="install-banner">
  <div class="install-inner">
    <div class="install-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
    </div>
    <div class="install-text">
      <strong>Add to Home Screen</strong><br>
      Quick access like an app
    </div>
    <button class="install-btn" id="install-btn">Install</button>
    <button class="install-dismiss" id="install-dismiss">&times;</button>
  </div>
</div>

<div class="footer">
  MUAI &middot; Birmingham Islamic Prayer Notification System
</div>

<script>
// SVG icons for each prayer (clean, no emoji)
const PRAYER_ICONS = {
  fajr: '<svg viewBox="0 0 24 24" fill="none" stroke="#3d6b8e" stroke-width="2" stroke-linecap="round"><path d="M12 3v3M5.6 5.6l2.1 2.1M3 12h3M5.6 18.4l2.1-2.1M12 21v-3M18.4 18.4l-2.1-2.1M21 12h-3M18.4 5.6l-2.1 2.1"/><circle cx="12" cy="12" r="4"/></svg>',
  sunrise: '<svg viewBox="0 0 24 24" fill="none" stroke="#c4842b" stroke-width="2" stroke-linecap="round"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="3"/><line x1="4.2" y1="10.2" x2="5.6" y2="11.6"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.4" y1="11.6" x2="19.8" y2="10.2"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8,6 12,2 16,6"/></svg>',
  zuhr: '<svg viewBox="0 0 24 24" fill="none" stroke="#5a8a3e" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.2" y1="4.2" x2="5.6" y2="5.6"/><line x1="18.4" y1="18.4" x2="19.8" y2="19.8"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.2" y1="19.8" x2="5.6" y2="18.4"/><line x1="18.4" y1="5.6" x2="19.8" y2="4.2"/></svg>',
  asr: '<svg viewBox="0 0 24 24" fill="none" stroke="#b8862b" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M2 12h2M20 12h2M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/></svg>',
  maghrib: '<svg viewBox="0 0 24 24" fill="none" stroke="#8b5a8e" stroke-width="2" stroke-linecap="round"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="4.2" y1="10.2" x2="5.6" y2="11.6"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.4" y1="11.6" x2="19.8" y2="10.2"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8,14 12,18 16,14"/></svg>',
  isha: '<svg viewBox="0 0 24 24" fill="none" stroke="#3a5a8e" stroke-width="2" stroke-linecap="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/><circle cx="18" cy="5" r="1" fill="#3a5a8e"/></svg>',
};

const PRAYER_META = {
  'Fajr has begun':     { name: 'Fajr',    iconKey: 'fajr',    order: 0 },
  'Sunrise':            { name: 'Sunrise',  iconKey: 'sunrise', order: 1 },
  'Zuhr has begun':     { name: 'Zuhr',     iconKey: 'zuhr',    order: 2 },
  "Zuhr has begun \u00b7 Jumu'ah": { name: "Jumu'ah", iconKey: 'zuhr', order: 2 },
  'Asr has begun':      { name: 'Asr',      iconKey: 'asr',     order: 3 },
  'Maghrib has begun':  { name: 'Maghrib',  iconKey: 'maghrib', order: 4 },
  'Isha has begun':     { name: 'Isha',     iconKey: 'isha',    order: 5 },
};

function lookupMeta(title) {
  let meta = PRAYER_META[title];
  if (!meta && title && (title.startsWith('Fajr') || title.startsWith('Fajr has begun'))) meta = PRAYER_META['Fajr has begun'];
  return meta || { name: title, iconKey: 'fajr', order: 99 };
}

let nextPrayerUTC = null;
let nextJamatUTC = null;
let nextJamatLabel = '';
let todayPrayers = []; // stored so we can recalculate next jama'ah
let allDays = []; // all days from queue for calendar
let calDayIndex = 0;

// ── Jama'ah toggle ──
const jamatToggle = document.getElementById('jamat-toggle');
const jamatRow = document.getElementById('cd-jamat-row');
jamatToggle.checked = localStorage.getItem('showJamat') === 'true';
function applyJamatToggle() {
  const on = jamatToggle.checked;
  localStorage.setItem('showJamat', on);
  if (on && nextJamatUTC) {
    jamatRow.classList.add('visible');
  } else {
    jamatRow.classList.remove('visible');
  }
}
jamatToggle.addEventListener('change', applyJamatToggle);
applyJamatToggle();

// Find the next jama'ah that hasn't passed yet from ALL today's prayers
function findNextJamat() {
  const nowISO = new Date().toISOString();
  for (const p of todayPrayers) {
    if (p.jamatUTC && p.jamatUTC > nowISO) {
      const meta = lookupMeta(p.title);
      return { utc: p.jamatUTC, timeFmt: p.jamatTimeFmt || '', name: meta.name };
    }
  }
  return null;
}

function fmtCountdown(ms) {
  if (ms <= 0) return '0:00';
  const totalSec = Math.floor(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

function tickCountdown() {
  if (!nextPrayerUTC) return;
  const diff = new Date(nextPrayerUTC).getTime() - Date.now();
  const el = document.getElementById('cd-time');
  const labelEl = document.getElementById('cd-remaining-label');
  if (diff <= 0) {
    el.textContent = 'Now';
    labelEl.textContent = '';
    setTimeout(fetchTimes, 60000);
  } else {
    el.textContent = fmtCountdown(diff);
    labelEl.textContent = 'remaining';
  }

  // Jama'ah countdown — independently find next upcoming jama'ah
  if (nextJamatUTC) {
    const jDiff = new Date(nextJamatUTC).getTime() - Date.now();
    const jamatEl = document.getElementById('cd-jamat-time');
    if (jDiff <= 0) {
      // This jama'ah has passed — find the next one
      const next = findNextJamat();
      if (next) {
        nextJamatUTC = next.utc;
        nextJamatLabel = next.name;
        document.getElementById('cd-jamat-at').textContent = `${next.name} · ${next.timeFmt}`;
        jamatEl.textContent = fmtCountdown(new Date(next.utc).getTime() - Date.now());
      } else {
        nextJamatUTC = null;
        jamatEl.textContent = '—';
        applyJamatToggle();
      }
    } else {
      jamatEl.textContent = fmtCountdown(jDiff);
    }
  }
}

function extractJamat(details) {
  if (!details) return '';
  const match = details.match(/Jamat\s*[·\u00b7]\s*(.+)/);
  if (match) return 'Jamat ' + match[1].trim();
  const matchAt = details.match(/Jamat at (.+)/);
  if (matchAt) return 'Jamat ' + matchAt[1].trim();
  return '';
}

function renderPrayers(prayers, nextPrayer) {
  const list = document.getElementById('prayer-list');
  list.classList.remove('loading');

  if (!prayers || prayers.length === 0) {
    list.innerHTML = '<div class="no-data"><div class="no-data-icon">&#x1F54C;</div>No prayer times scheduled for today.<br>Check back soon.</div>';
    return;
  }

  const sorted = prayers
    .map(p => ({ ...p, meta: lookupMeta(p.title) }))
    .sort((a, b) => a.meta.order - b.meta.order);

  const nowISO = new Date().toISOString();
  let foundNext = false;

  let html = '';
  for (const p of sorted) {
    const isPast = p.fireUTC && p.fireUTC <= nowISO;
    const isNext = !foundNext && p.fireUTC && p.fireUTC > nowISO;
    if (isNext) foundNext = true;

    const stateClass = isNext ? 'active' : (isPast ? 'past' : '');
    const jamat = extractJamat(p.details);
    const icon = PRAYER_ICONS[p.meta.iconKey] || PRAYER_ICONS.fajr;

    html += `<div class="prayer-row ${stateClass}">
      <div class="prayer-icon">${icon}</div>
      <div class="prayer-info">
        <div class="prayer-name">${p.meta.name}</div>
        ${jamat ? `<div class="prayer-jamat">${jamat}</div>` : ''}
      </div>
      <div class="prayer-time-col">
        <div class="prayer-adhan-time">${p.fireTimeFmt || '\u2014'}</div>
      </div>
    </div>`;
  }

  list.innerHTML = html;
}

// ── Calendar navigation ──

function groupByDay(queue) {
  const map = new Map();
  for (const n of queue) {
    const key = n.gregFull || 'Unknown';
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(n);
  }
  return Array.from(map.entries()).map(([label, prayers]) => ({ label, prayers }));
}

function renderCalendarDay() {
  if (allDays.length === 0) return;
  const day = allDays[calDayIndex];
  document.getElementById('cal-label').textContent = day.label;
  document.getElementById('cal-sub').textContent = `Day ${calDayIndex + 1} of ${allDays.length}`;

  document.getElementById('cal-prev').disabled = calDayIndex === 0;
  document.getElementById('cal-next').disabled = calDayIndex >= allDays.length - 1;

  const sorted = day.prayers
    .map(p => ({ ...p, meta: lookupMeta(p.title) }))
    .sort((a, b) => a.meta.order - b.meta.order);

  let html = `<div class="cal-prayer-row" style="padding:8px 18px;border-bottom:1px solid #eee;">
    <div class="cal-prayer-name" style="font-size:0.65rem;color:var(--text-muted);font-weight:600;letter-spacing:0.06em;text-transform:uppercase;">Prayer</div>
    <div class="cal-prayer-time" style="font-size:0.65rem;color:var(--text-muted);font-weight:600;letter-spacing:0.06em;text-transform:uppercase;">Time</div>
    <div class="cal-prayer-jamat" style="font-size:0.65rem;color:var(--text-muted);font-weight:600;letter-spacing:0.06em;text-transform:uppercase;">Jamat</div>
  </div>`;
  for (const p of sorted) {
    const jamat = extractJamat(p.details);
    const icon = PRAYER_ICONS[p.meta.iconKey] || PRAYER_ICONS.fajr;
    html += `<div class="cal-prayer-row">
      <div class="cal-prayer-name"><span class="cal-prayer-icon">${icon}</span>${p.meta.name}</div>
      <div class="cal-prayer-time">${p.fireTimeFmt || '\u2014'}</div>
      <div class="cal-prayer-jamat">${jamat || '\u00A0'}</div>
    </div>`;
  }

  document.getElementById('cal-list').innerHTML = html;
}

async function fetchTimes() {
  try {
    const resp = await fetch('/api/times');
    if (!resp.ok) throw new Error('Failed');
    const data = await resp.json();

    document.getElementById('hero-date').textContent = data.todayLabel || '';
    renderPrayers(data.today, data.nextPrayer);

    // Store today's prayers (sorted by jamatUTC) for jama'ah lookup
    todayPrayers = (data.today || [])
      .filter(p => p.jamatUTC)
      .sort((a, b) => a.jamatUTC.localeCompare(b.jamatUTC));

    if (data.nextPrayer && data.nextPrayer.fireUTC) {
      nextPrayerUTC = data.nextPrayer.fireUTC;
      const meta = lookupMeta(data.nextPrayer.title);

      document.getElementById('cd-prayer').textContent = meta.name;
      document.getElementById('cd-at').textContent = data.nextPrayer.fireTimeFmt || '';

      // Find next upcoming jama'ah independently of nextPrayer
      const nextJamat = findNextJamat();
      if (nextJamat) {
        nextJamatUTC = nextJamat.utc;
        nextJamatLabel = nextJamat.name;
        document.getElementById('cd-jamat-at').textContent = `${nextJamat.name} · ${nextJamat.timeFmt}`;
      } else {
        nextJamatUTC = null;
      }
      applyJamatToggle();
      tickCountdown();
    } else {
      document.getElementById('cd-prayer').textContent = '\u2014';
      document.getElementById('cd-time').textContent = '\u2014';
      document.getElementById('cd-at').textContent = '';
      document.getElementById('cd-remaining-label').textContent = 'No upcoming prayers';
      nextJamatUTC = null;
      applyJamatToggle();
    }

    // Build calendar from all queue data
    await fetchCalendar();
  } catch (e) {
    console.error('Failed to load times:', e);
    document.getElementById('prayer-list').innerHTML = '<div class="no-data"><div class="no-data-icon">&#x26A0;&#xFE0F;</div>Could not load prayer times.<br>Please try again later.</div>';
  }
}

async function fetchCalendar() {
  try {
    const resp = await fetch('/api/calendar');
    if (!resp.ok) return;
    const data = await resp.json();

    if (data.days && data.days.length > 0) {
      allDays = data.days;
      calDayIndex = 0;
      document.getElementById('calendar-section').style.display = '';
      renderCalendarDay();
    }
  } catch (e) {
    console.error('Calendar fetch failed:', e);
  }
}

// Calendar nav events
document.getElementById('cal-prev').addEventListener('click', () => {
  if (calDayIndex > 0) { calDayIndex--; renderCalendarDay(); }
});
document.getElementById('cal-next').addEventListener('click', () => {
  if (calDayIndex < allDays.length - 1) { calDayIndex++; renderCalendarDay(); }
});

// Init
fetchTimes();
setInterval(tickCountdown, 1000);
setInterval(fetchTimes, 5 * 60 * 1000);

// ── PWA: Service Worker ──
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// ── PWA: Install prompt ──
let deferredPrompt = null;
const banner = document.getElementById('install-banner');
const installBtn = document.getElementById('install-btn');
const dismissBtn = document.getElementById('install-dismiss');

// Show banner if not already installed and not dismissed this session
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  if (!isStandalone && !sessionStorage.getItem('pwa-dismissed')) {
    banner.classList.add('show');
  }
});

installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
  }
  banner.classList.remove('show');
});

dismissBtn.addEventListener('click', () => {
  banner.classList.remove('show');
  sessionStorage.setItem('pwa-dismissed', '1');
});

// For iOS Safari (no beforeinstallprompt), show manual instructions
if (/iPhone|iPad/.test(navigator.userAgent) && !isStandalone && !sessionStorage.getItem('pwa-dismissed')) {
  banner.classList.add('show');
  installBtn.textContent = 'How?';
  installBtn.addEventListener('click', () => {
    alert('Tap the Share button (box with arrow) at the bottom of Safari, then tap "Add to Home Screen"');
  }, { once: true });
}
</script>
</body>
</html>
