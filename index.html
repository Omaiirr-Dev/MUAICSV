<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MUAI Prayer Times</title>
  <style>
    :root {
      --bg: #0d0d0d;
      --surface: #161616;
      --surface2: #1e1e1e;
      --border: #2a2a2a;
      --accent: #c9a84c;
      --accent-dim: #7a6330;
      --text: #e8e8e8;
      --text-muted: #888;
      --fajr: #5b8fa8;
      --sunrise: #d4832a;
      --zuhr: #6bb86b;
      --asr: #c4934a;
      --maghrib: #9b6fb5;
      --isha: #4a7dc4;
      --fri: #2a3d1a;
      --fri-border: #5a8f2a;
      --sat: #1a2a3d;
      --sat-border: #2a5a8f;
      --sun: #1a2a3d;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header .logo {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.05em;
    }

    header .subtitle {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Upload zone */
    .upload-zone {
      border: 2px dashed #5a2020;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      background: #1a0e0e;
      cursor: pointer;
      transition: border-color 0.3s, background 0.3s, box-shadow 0.3s;
      position: relative;
    }

    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--accent);
      background: #1a1600;
    }

    .upload-zone.accepted {
      border-color: #2a7a2a;
      border-style: solid;
      background: #0d1f0d;
    }

    .upload-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .upload-icon { font-size: 2.5rem; margin-bottom: 12px; }

    .upload-zone h2 {
      font-size: 1.1rem;
      color: var(--text);
      margin-bottom: 6px;
    }

    .upload-zone p {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }

    .btn:hover { opacity: 0.85; }
    .btn:active { transform: scale(0.97); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .btn-primary {
      background: var(--accent);
      color: #111;
    }

    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: #8a1818;
      color: #f8c0c0;
      border: 1px solid #c03030;
    }

    .btn-success {
      background: #1a6b1a;
      color: #c0f0c0;
      border: 1px solid #30b030;
    }

    .btn-ntfy {
      background: #8a1818;
      color: #fff;
      border: 1px solid #c03030;
      font-size: 0.88rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    /* Month info bar */
    .month-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .month-bar .month-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
    }

    .month-bar .stats {
      display: flex;
      gap: 16px;
      color: var(--text-muted);
      font-size: 0.82rem;
    }

    .month-bar .stats span strong {
      color: var(--text);
    }

    /* Actions bar */
    .actions-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Prayer times table */
    .table-wrap {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.83rem;
      min-width: 900px;
    }

    thead th {
      background: var(--surface);
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }

    thead .th-group {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    thead .th-fajr { color: var(--fajr); }
    thead .th-sunrise { color: var(--sunrise); }
    thead .th-zuhr { color: var(--zuhr); }
    thead .th-asr { color: var(--asr); }
    thead .th-maghrib { color: var(--maghrib); }
    thead .th-isha { color: var(--isha); }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }

    tbody tr:hover { background: #1a1a1a; }

    tbody tr.row-fri {
      background: var(--fri);
      border-left: 3px solid var(--fri-border);
    }

    tbody tr.row-fri:hover { background: #304020; }

    tbody tr.row-sat { background: #1a1a2a; }
    tbody tr.row-sun { background: #1a1a2a; }

    tbody td {
      padding: 9px 8px;
      text-align: center;
      white-space: nowrap;
    }

    .col-day { font-weight: 700; }
    .col-day.fri { color: var(--fri-border); }
    .col-day.sat { color: #6a9fd4; }
    .col-day.sun { color: #6a9fd4; }

    .col-date-hijri {
      color: var(--accent);
      font-weight: 600;
    }

    .col-date-greg {
      color: var(--text-muted);
      font-size: 0.78rem;
    }

    .time-cell {
      font-family: 'Courier New', monospace;
      font-size: 0.88rem;
    }

    .jamat-cell {
      font-family: 'Courier New', monospace;
      font-size: 0.88rem;
      font-weight: 700;
    }

    .fajr-time { color: var(--fajr); }
    .fajr-jamat { color: #a0d0e8; }
    .sunrise-time { color: var(--sunrise); }
    .zuhr-time { color: var(--zuhr); }
    .zuhr-jamat { color: #a0e8a0; }
    .asr-time { color: var(--asr); }
    .asr-jamat { color: #e8c080; }
    .maghrib-time { color: var(--maghrib); }
    .maghrib-jamat { color: #c8a0d8; }
    .isha-time { color: var(--isha); }
    .isha-jamat { color: #80b0e8; }

    .cell-empty { color: #333; }

    /* Notification preview panel */
    .preview-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-top: 24px;
    }

    .preview-panel h3 {
      color: var(--accent);
      margin-bottom: 16px;
      font-size: 1rem;
    }

    .notif-day {
      margin-bottom: 20px;
    }

    .notif-day-header {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }

    .notif-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 14px;
      margin-bottom: 6px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .notif-icon { font-size: 1.1rem; flex-shrink: 0; }

    .notif-body { flex: 1; }

    .notif-title {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .notif-sub {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .notif-countdown {
      font-size: 0.82rem;
      color: var(--accent);
      margin-top: 4px;
      font-weight: 600;
    }

    .notif-firetime {
      font-size: 0.7rem;
      color: #555;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* Day filter tabs */
    .day-filter {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .day-tab {
      padding: 5px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-muted);
      font-size: 0.78rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .day-tab:hover, .day-tab.active {
      background: var(--accent);
      color: #111;
      border-color: var(--accent);
      font-weight: 700;
    }

    /* Error/status messages */
    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 0.88rem;
    }

    .alert-error {
      background: #2a1010;
      border: 1px solid #7a2020;
      color: #f0a0a0;
    }

    .alert-success {
      background: #102a10;
      border: 1px solid #207a20;
      color: #a0f0a0;
    }

    .alert-info {
      background: #10182a;
      border: 1px solid #204a7a;
      color: #a0c8f0;
    }

    /* Hidden */
    .hidden { display: none !important; }

    /* Section */
    .section {
      margin-bottom: 28px;
    }

    .section-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }

    .badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 700;
      background: var(--accent-dim);
      color: var(--accent);
    }

    .raw-toggle {
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      text-decoration: underline;
      margin-left: auto;
    }

    .raw-panel {
      background: #0a0a0a;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      color: #888;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }

    /* â”€â”€ Scheduled Notifications Section â”€â”€ */
    .sched-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .sched-header .sched-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent);
    }

    .sched-header .sched-count {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .sched-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .sched-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.88rem;
      padding: 32px;
      border: 1px dashed var(--border);
      border-radius: 8px;
    }

    /* Day row in scheduled list */
    .sched-day {
      border: 1px solid var(--border);
      border-radius: 7px;
      margin-bottom: 8px;
      overflow: hidden;
    }

    .sched-day-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s;
    }

    .sched-day-header:hover {
      background: #1c1c1c;
    }

    /* green = past/fired */
    .sched-day.past .sched-day-header {
      background: #0d1f0d;
      border-left: 3px solid #2a7a2a;
    }

    .sched-day.past .sched-day-header:hover {
      background: #112611;
    }

    /* orange = upcoming, pushed and scheduled in NTFY */
    .sched-day.upcoming .sched-day-header {
      background: #1f1600;
      border-left: 3px solid #a06000;
    }

    .sched-day.upcoming .sched-day-header:hover {
      background: #261c00;
    }

    .sched-day-label {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
      flex: 1;
    }

    .sched-day.past .sched-day-label     { color: #70d870; }
    .sched-day.upcoming .sched-day-label { color: #e0a030; }

    .sched-day-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .sched-day-chevron {
      font-size: 0.75rem;
      color: var(--text-muted);
      transition: transform 0.18s;
    }

    .sched-day.open .sched-day-chevron {
      transform: rotate(90deg);
    }

    .sched-day-body {
      display: none;
      padding: 10px 16px 14px;
      background: #101010;
      border-top: 1px solid var(--border);
    }

    .sched-day.open .sched-day-body {
      display: block;
    }

    .sched-notif-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 7px 0;
      border-bottom: 1px solid #1a1a1a;
    }

    .sched-notif-row:last-child {
      border-bottom: none;
    }

    .sched-notif-icon {
      font-size: 1rem;
      flex-shrink: 0;
      width: 24px;
      text-align: center;
    }

    .sched-notif-info {
      flex: 1;
    }

    .sched-notif-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
    }

    .sched-notif-detail {
      font-size: 0.76rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .sched-notif-time {
      font-size: 0.75rem;
      color: #555;
      text-align: right;
      white-space: nowrap;
    }

    .sched-notif-time .utc {
      display: block;
      font-size: 0.68rem;
      color: #444;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 5px;
    }

    .status-dot.past     { background: #30a830; }
    .status-dot.upcoming { background: #c07820; }

    .push-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .push-bar .push-info {
      flex: 1;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .push-bar .push-info strong {
      color: var(--text);
    }

    /* â”€â”€ Parse Mode Chooser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .parse-chooser {
      display: flex; gap: 10px; margin-top: 10px;
    }
    .parse-option {
      flex: 1; background: transparent; border: 1px solid var(--border); border-radius: 6px;
      padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px;
      transition: all 0.15s;
    }
    .parse-option:hover { border-color: #555; background: #1a1a1a; }
    .parse-option-icon { font-size: 1rem; flex-shrink: 0; }
    .parse-option-title { font-size: 0.85rem; font-weight: 600; color: var(--text); }
    .parse-option-desc { font-size: 0.72rem; color: #555; margin-top: 1px; }
    .parse-option.ai { border-color: #2a2418; }
    .parse-option.ai:hover { border-color: var(--accent-dim); background: #151208; }
    .parse-option.ai .parse-option-title { color: var(--accent); }
    .parse-loading {
      text-align: center; padding: 20px; color: #888; font-size: 0.85rem;
    }
    .parse-loading .spinner {
      display: inline-block; width: 16px; height: 16px; border: 2px solid #333;
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<header>
  <div>
    <div class="logo">ğŸ•Œ MUAI Prayer Times</div>
    <div class="subtitle">Birmingham Islamic Prayer Notification System</div>
  </div>
  <a href="/logout" style="margin-left:auto;font-size:0.78rem;color:#555;text-decoration:none;padding:6px 12px;border:1px solid #2a2a2a;border-radius:5px;" onmouseover="this.style.color='#e8e8e8'" onmouseout="this.style.color='#555'">Sign out</a>
</header>

<div class="main">

  <!-- Upload Section -->
  <div class="section" id="section-upload">
    <div class="section-title">Import CSV</div>
    <div class="upload-zone" id="drop-zone">
      <input type="file" id="csv-file" accept=".csv" />
      <div class="upload-icon">ğŸ“„</div>
      <h2>Drop your prayer times CSV here</h2>
      <p>or click to browse &nbsp;Â·&nbsp; Accepts MUAI Birmingham format</p>
    </div>
    <div style="margin-top:10px; text-align:right;">
      <span class="raw-toggle" id="paste-toggle">or paste CSV text instead</span>
    </div>
    <div id="paste-area" class="hidden" style="margin-top:10px;">
      <textarea id="csv-paste" rows="6" style="width:100%;background:#0a0a0a;color:#aaa;border:1px solid var(--border);border-radius:6px;padding:10px;font-family:monospace;font-size:0.78rem;resize:vertical;" placeholder="Paste CSV content here..."></textarea>
      <button class="btn btn-secondary" style="margin-top:8px;" id="parse-paste-btn">Parse Pasted CSV</button>
    </div>
  </div>

  <!-- Parse Mode Chooser (shown after CSV loaded) -->
  <div id="parse-chooser-wrap" class="section hidden">
    <div class="section-title">How should we read this CSV?</div>
    <div class="parse-chooser">
      <div class="parse-option" id="parse-script">
        <div class="parse-option-icon">âš¡</div>
        <div>
          <div class="parse-option-title">Script Parse</div>
          <div class="parse-option-desc">Standard MUAI format</div>
        </div>
      </div>
      <div class="parse-option ai hidden" id="parse-ai">
        <div class="parse-option-icon">ğŸ¤–</div>
        <div>
          <div class="parse-option-title">AI Parse</div>
          <div class="parse-option-desc">Any CSV format</div>
        </div>
      </div>
    </div>
    <div id="parse-loading" class="parse-loading hidden">
      <span class="spinner"></span> AI is reading your timetable...
    </div>
  </div>

  <!-- Alert area -->
  <div id="alert-area"></div>

  <!-- Parsed data area (hidden until CSV loaded) -->
  <div id="data-area" class="hidden">

    <!-- Month info -->
    <div class="section">
      <div class="section-title">Parsed Month</div>
      <div class="month-bar">
        <div class="month-title" id="month-title">â€”</div>
        <div class="stats">
          <span><strong id="stat-days">0</strong> days</span>
          <span><strong id="stat-fri">0</strong> Fridays</span>
        </div>
        <button class="btn btn-secondary" id="clear-btn" style="margin-left:auto;">âœ• Clear</button>
      </div>
      <div class="date-range-bar" id="date-range-bar" style="margin-top:10px;background:#111;border:1px solid #2a2a2a;border-radius:7px;padding:11px 18px;font-size:0.82rem;color:#aaa;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
        <span style="color:#555">Notifications scheduled:</span>
        <span id="stat-start-eng" style="color:#e8e8e8;font-weight:600;">â€”</span>
        <span style="color:#444">â†’</span>
        <span id="stat-end-eng" style="color:#e8e8e8;font-weight:600;">â€”</span>
        <span style="color:#555;margin-left:8px;">Â·</span>
        <span id="stat-total-notifs" style="color:#c9a84c;font-weight:700;">0 notifications</span>
        <span style="color:#555;">across</span>
        <span id="stat-days2" style="color:#c9a84c;font-weight:700;">0 days</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="section">
      <div class="section-title">Actions</div>
      <div class="actions-bar">
        <button class="btn btn-primary" id="preview-btn">ğŸ‘ Preview Notifications</button>
        <button class="btn btn-ntfy" id="push-ntfy-btn">ğŸ”´ PUSH TO NTFY</button>
        <button class="btn btn-secondary" id="raw-btn">Show Raw Parsed JSON</button>
      </div>
    </div>

    <!-- Prayer times table -->
    <div class="section">
      <div class="section-title">Prayer Times â€” Parsed Data</div>
      <div class="table-wrap">
        <table id="prayer-table">
          <thead>
            <tr>
              <th rowspan="2" style="min-width:44px;">Day</th>
              <th rowspan="2" style="min-width:40px;">Hijri</th>
              <th rowspan="2" style="min-width:60px;">Date</th>
              <th colspan="2" class="th-group th-fajr">Fajr</th>
              <th rowspan="2" class="th-group th-sunrise">Sunrise</th>
              <th colspan="2" class="th-group th-zuhr">Zuhr</th>
              <th colspan="2" class="th-group th-asr">Asr</th>
              <th colspan="2" class="th-group th-maghrib">Maghrib</th>
              <th colspan="2" class="th-group th-isha">Isha</th>
            </tr>
            <tr>
              <th class="th-fajr">Start</th>
              <th class="th-fajr">Jamat</th>
              <th class="th-zuhr">Start</th>
              <th class="th-zuhr">Jamat</th>
              <th class="th-asr">Start</th>
              <th class="th-asr">Jamat</th>
              <th class="th-maghrib">Adhan</th>
              <th class="th-maghrib">Jamat</th>
              <th class="th-isha">Start</th>
              <th class="th-isha">Jamat</th>
            </tr>
          </thead>
          <tbody id="prayer-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Raw JSON panel -->
    <div id="raw-json-panel" class="hidden section">
      <div class="section-title">Raw Parsed JSON</div>
      <div class="raw-panel" id="raw-json-content"></div>
    </div>

    <!-- Notification preview -->
    <div id="preview-panel-wrap" class="hidden section">
      <div class="section-title">Notification Preview</div>
      <div class="day-filter" id="day-filter-tabs"></div>
      <div class="preview-panel" id="preview-container"></div>
    </div>

  </div>

  <!-- â”€â”€ Scheduled Notifications Section â”€â”€ -->
  <div class="section" id="section-scheduled">
    <div class="section-title">Scheduled Notifications Ready for NTFY</div>

    <div class="sched-header">
      <div>
        <div class="sched-title">ğŸ“… Notification Queue</div>
        <div class="sched-count" id="sched-count">Loadingâ€¦</div>
      </div>
      <div class="sched-actions">
        <button class="btn btn-danger" id="delete-future-btn">ğŸ—‘ Delete All Future</button>
      </div>
    </div>

    <div id="sched-list"></div>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CSV PARSER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function parseCSV(text) {
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');

  function splitLine(line) {
    const fields = [];
    let cur = '';
    let inQuote = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuote && line[i + 1] === '"') { cur += '"'; i++; }
        else { inQuote = !inQuote; }
      } else if (ch === ',' && !inQuote) {
        fields.push(cur.trim());
        cur = '';
      } else {
        cur += ch;
      }
    }
    fields.push(cur.trim());
    return fields;
  }

  const joinedLines = [];
  let buffer = '';
  let quoteCount = 0;
  for (const line of lines) {
    quoteCount += (line.match(/"/g) || []).length;
    buffer += (buffer ? '\n' : '') + line;
    if (quoteCount % 2 === 0) {
      joinedLines.push(buffer);
      buffer = '';
    }
  }
  if (buffer) joinedLines.push(buffer);

  return joinedLines.map(splitLine);
}

function extractMonthTitle(rows) {
  const ISLAMIC_MONTHS = [
    'muharram','safar','rabi al-awwal','rabi al-thani','rabi ul awwal','rabi ul thani',
    'jumada al-awwal','jumada al-thani','jumada ul awwal','jumada ul thani',
    'rajab','sha\'ban','shaban','ramadan','ramadhan','shawwal',
    'dhul qadah','dhul hijjah','rabi','jumada'
  ];

  for (const row of rows.slice(0, 8)) {
    for (const cell of row) {
      if (!cell) continue;
      const lower = cell.toLowerCase().replace(/\n/g,' ').trim();
      for (const m of ISLAMIC_MONTHS) {
        if (lower.includes(m)) return cell.replace(/\n/g, ' ').trim();
      }
    }
  }

  for (const row of rows.slice(0, 8)) {
    for (const cell of row) {
      if (cell && cell.trim().length > 3 && !cell.includes(',') && !/\d/.test(cell)) {
        const words = cell.trim().split(/\s+/);
        if (words.length <= 3) return cell.replace(/\n/g, ' ').trim();
      }
    }
  }

  return 'Birmingham Prayer Times';
}

const DAY_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

function normaliseDay(cell) {
  if (!cell) return '';
  const s = cell.trim().toLowerCase();
  return DAY_NAMES.find(d => d.toLowerCase() === s) || '';
}

function findDataStart(rows) {
  for (let i = 0; i < rows.length; i++) {
    if (normaliseDay(rows[i][1])) return i;
  }
  return -1;
}

function resolveTime(value, lastValue) {
  if (!value || value === '' || value === '"') return lastValue;
  return value;
}

function parsePrayerData(rows) {
  const title = extractMonthTitle(rows);
  const dataStart = findDataStart(rows);
  if (dataStart === -1) throw new Error('Could not find prayer time data rows. Is this the right CSV format?');

  const days = [];
  const last = {
    fajrJamat: '', zuhrJamat: '', asrJamat: '',
    maghribJamat: '', ishaJamat: ''
  };

  const GREG_MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const GREG_MONTH_LOWER = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

  function matchMonth(cell) {
    const s = (cell || '').trim().toLowerCase();
    if (!s) return -1;
    const exact = GREG_MONTH_LOWER.indexOf(s);
    if (exact !== -1) return exact;
    for (let i = 0; i < GREG_MONTH_LOWER.length; i++) {
      if (s.startsWith(GREG_MONTH_LOWER[i])) return i;
    }
    return -1;
  }

  let runningMonth = -1;
  let runningYear  = new Date().getFullYear();
  let runningDay   = 0;

  for (let i = 0; i < dataStart; i++) {
    for (const cell of rows[i]) {
      const mi = matchMonth(cell);
      if (mi !== -1) { runningMonth = mi; break; }
    }
    if (runningMonth !== -1) break;
  }

  if (runningMonth === -1) {
    for (let i = dataStart; i < rows.length; i++) {
      const cell = (rows[i][3] || '').trim();
      const mi = matchMonth(cell);
      if (mi !== -1) {
        runningMonth = mi === 0 ? 11 : mi - 1;
        if (mi === 0) runningYear--;
        break;
      }
    }
  }

  for (let i = dataStart; i < rows.length; i++) {
    const r = rows[i];
    const dayName = normaliseDay(r[1]);

    if (!dayName) {
      const mi = matchMonth(r[3]);
      if (mi !== -1) runningMonth = mi;
      continue;
    }

    const gregRaw = (r[3] || '').trim();
    const gregMonthIdx = matchMonth(gregRaw);

    let gregDayNum;
    if (gregMonthIdx !== -1) {
      runningMonth = gregMonthIdx;
      runningDay   = 1;
      gregDayNum   = 1;
    } else {
      const parsed = parseInt(gregRaw);
      if (!isNaN(parsed)) {
        gregDayNum = parsed;
        runningDay = parsed;
      } else {
        runningDay++;
        const daysInMonth = new Date(runningYear, runningMonth + 1, 0).getDate();
        if (runningDay > daysInMonth) {
          runningDay = 1;
          runningMonth = (runningMonth + 1) % 12;
          if (runningMonth === 0) runningYear++;
        }
        gregDayNum = runningDay;
      }
    }

    const gregMonthStr = GREG_MONTH_NAMES[runningMonth] || '?';
    const gregFull = `${dayName}, ${gregDayNum} ${gregMonthStr} ${runningYear}`;

    // Store numeric date for UTC conversion
    const gregYear  = runningYear;
    const gregMonth = runningMonth; // 0-based
    const gregDay   = gregDayNum;

    const fajrJamat    = resolveTime(r[5],  last.fajrJamat);
    const zuhrJamat    = resolveTime(r[8],  last.zuhrJamat);
    const asrJamat     = resolveTime(r[10], last.asrJamat);
    const maghribJamat = resolveTime(r[12], last.maghribJamat);
    const ishaJamat    = resolveTime(r[14], last.ishaJamat);

    last.fajrJamat    = fajrJamat;
    last.zuhrJamat    = zuhrJamat;
    last.asrJamat     = asrJamat;
    last.maghribJamat = maghribJamat;
    last.ishaJamat    = ishaJamat;

    days.push({
      day:           dayName,
      hijriDate:     r[2] || '',
      gregDate:      gregRaw,
      gregFull:      gregFull,
      gregYear,
      gregMonth,
      gregDay,
      fajrStart:     r[4] || '',
      fajrJamat,
      sunrise:       r[6] || '',
      zuhrStart:     r[7] || '',
      zuhrJamat,
      asrStart:      r[9] || '',
      asrJamat,
      maghribAdhan:  r[11] || '',
      maghribJamat,
      ishaStart:     r[13] || '',
      ishaJamat,
    });
  }

  if (days.length === 0) throw new Error('No prayer day rows found. Check CSV structure.');

  return { title, days };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TIME UTILITIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function timeTo24(t) {
  if (!t) return null;
  const parts = t.match(/^(\d+):(\d+)$/);
  if (!parts) return null;
  return { h: parseInt(parts[1]), m: parseInt(parts[2]) };
}

function resolveSequential(times) {
  let prev = 0;
  return times.map(t => {
    if (!t) return null;
    let mins = t.h * 60 + t.m;
    if (mins < prev) mins += 12 * 60;
    prev = mins;
    return mins;
  });
}

function minutesBetween(fromMins, toMins) {
  if (fromMins === null || toMins === null) return null;
  return toMins - fromMins;
}

function formatDiff(mins) {
  if (mins === null || mins < 0) return null;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (h === 0) return `${m}m`;
  if (m === 0) return `${h}h`;
  return `${h}h ${m}m`;
}

function fmtTime(t) {
  if (!t) return 'â€”';
  const p = timeTo24(t);
  if (!p) return t;
  const ampm = p.h < 12 ? 'AM' : 'PM';
  const h = p.h % 12 || 12;
  const m = String(p.m).padStart(2, '0');
  return `${h}:${m} ${ampm}`;
}

// Convert a prayer time string (e.g. "5:23") for a given calendar date to UTC ISO string.
// Uses the same sequential unwrapping as resolveSequential.
// minsResolved: the already-resolved total minutes (from resolveSequential)
function resolvedMinsToUTC(gregYear, gregMonth, gregDay, resolvedMins) {
  // resolvedMins may be > 1440 if wrap added 720; clamp to real hour/min
  const totalMins = resolvedMins % (24 * 60);
  const h = Math.floor(totalMins / 60);
  const m = totalMins % 60;

  // Build a candidate UTC date assuming UK local = resolved H:MM on this calendar day.
  // Use Intl to figure out the actual UTC offset for London on that date.
  const guessUTC = Date.UTC(gregYear, gregMonth, gregDay, h, m, 0, 0);

  const londonParts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/London',
    hour: 'numeric', minute: 'numeric', hour12: false,
  }).formatToParts(new Date(guessUTC));

  const londonH = parseInt(londonParts.find(p => p.type === 'hour').value);
  const londonM = parseInt(londonParts.find(p => p.type === 'minute').value);

  const offsetMins = (londonH * 60 + londonM) - (h * 60 + m);
  const utcMs = guessUTC - offsetMins * 60 * 1000;
  return new Date(utcMs).toISOString();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTIFICATION BUILDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function formatEngDate(day) {
  return day.gregFull || `${day.day} ${day.gregDate}`;
}

function buildNotifications(day) {
  const notes = [];

  const rawTimes = [
    timeTo24(day.fajrStart),
    timeTo24(day.zuhrStart),
    timeTo24(day.asrStart),
    timeTo24(day.maghribAdhan),
    timeTo24(day.ishaStart),
  ];

  const [fajrM, zuhrM, asrM, maghribM, ishaM] = resolveSequential(rawTimes);

  function getFireUTC(resolvedMins) {
    if (resolvedMins === null) return null;
    return resolvedMinsToUTC(day.gregYear, day.gregMonth, day.gregDay, resolvedMins);
  }

  const prayers = [
    {
      icon: 'ğŸ•‹',
      title: `Fajr has begun`,
      details: day.sunrise ? `Sunrise ${fmtTime(day.sunrise)}` : '',
      countdown: formatDiff(minutesBetween(fajrM, zuhrM)),
      nextName: 'Zuhr',
      nextTime: fmtTime(day.zuhrStart),
      fireTimeFmt: fmtTime(day.fajrStart),
      fireUTC: getFireUTC(fajrM),
    },
    {
      icon: 'â˜€ï¸',
      title: `Zuhr has begun${day.day === 'Fri' ? ' Â· Jumu\'ah' : ''}`,
      details: '',
      countdown: formatDiff(minutesBetween(zuhrM, asrM)),
      nextName: 'Asr',
      nextTime: fmtTime(day.asrStart),
      fireTimeFmt: fmtTime(day.zuhrStart),
      fireUTC: getFireUTC(zuhrM),
    },
    {
      icon: 'â›…',
      title: `Asr has begun`,
      details: '',
      countdown: formatDiff(minutesBetween(asrM, maghribM)),
      nextName: 'Maghrib',
      nextTime: fmtTime(day.maghribAdhan),
      fireTimeFmt: fmtTime(day.asrStart),
      fireUTC: getFireUTC(asrM),
    },
    {
      icon: 'ğŸŒ…',
      title: `Maghrib has begun`,
      details: '',
      countdown: formatDiff(minutesBetween(maghribM, ishaM)),
      nextName: 'Isha',
      nextTime: fmtTime(day.ishaStart),
      fireTimeFmt: fmtTime(day.maghribAdhan),
      fireUTC: getFireUTC(maghribM),
    },
    {
      icon: 'ğŸŒ™',
      title: `Isha has begun`,
      details: '',
      countdown: null,
      nextName: null,
      nextTime: null,
      fireTimeFmt: fmtTime(day.ishaStart),
      fireUTC: getFireUTC(ishaM),
    },
  ];

  for (const p of prayers) {
    notes.push({
      icon: p.icon,
      title: p.title,
      details: p.details,
      countdown: p.countdown ? `â° ${p.countdown} until ${p.nextName} Â· ${p.nextTime}` : null,
      fireTimeFmt: p.fireTimeFmt,
      fireUTC: p.fireUTC,
      priority: 'urgent',
      gregFull: day.gregFull,
    });
  }

  return notes;
}

function buildAllNotifications(data) {
  const all = [];
  for (const day of data.days) {
    for (const n of buildNotifications(day)) {
      all.push(n);
    }
  }
  return all;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOM RENDERING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let parsedData = null;
let pendingCSVText = null;  // raw CSV text waiting for parse mode choice
let aiAvailable = false;    // set on page load

function showAlert(msg, type = 'info') {
  const el = document.getElementById('alert-area');
  el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => { el.innerHTML = ''; }, 6000);
}

function renderTable(data) {
  const tbody = document.getElementById('prayer-tbody');
  tbody.innerHTML = '';

  for (const d of data.days) {
    const tr = document.createElement('tr');
    const isDay = d.day.toLowerCase();
    if (isDay === 'fri') tr.className = 'row-fri';
    else if (isDay === 'sat') tr.className = 'row-sat';
    else if (isDay === 'sun') tr.className = 'row-sun';

    const dayClass = ['fri','sat','sun'].includes(isDay) ? isDay : '';

    function tc(val, cls) {
      return `<td class="time-cell ${cls}">${val || '<span class="cell-empty">â€”</span>'}</td>`;
    }
    function jc(val, cls) {
      return `<td class="jamat-cell ${cls}">${val || '<span class="cell-empty">â€”</span>'}</td>`;
    }

    tr.innerHTML = `
      <td class="col-day ${dayClass}">${d.day}</td>
      <td class="col-date-hijri">${d.hijriDate}</td>
      <td class="col-date-greg">${d.gregDate}</td>
      ${tc(d.fajrStart,    'fajr-time')}
      ${jc(d.fajrJamat,   'fajr-jamat')}
      ${tc(d.sunrise,      'sunrise-time')}
      ${tc(d.zuhrStart,    'zuhr-time')}
      ${jc(d.zuhrJamat,   'zuhr-jamat')}
      ${tc(d.asrStart,     'asr-time')}
      ${jc(d.asrJamat,    'asr-jamat')}
      ${tc(d.maghribAdhan, 'maghrib-time')}
      ${jc(d.maghribJamat,'maghrib-jamat')}
      ${tc(d.ishaStart,    'isha-time')}
      ${jc(d.ishaJamat,   'isha-jamat')}
    `;
    tbody.appendChild(tr);
  }
}

function renderMonthBar(data) {
  document.getElementById('month-title').textContent = data.title;
  document.getElementById('stat-days').textContent  = data.days.length;
  document.getElementById('stat-fri').textContent   = data.days.filter(d => d.day === 'Fri').length;
  const first = data.days[0];
  const last  = data.days[data.days.length - 1];
  document.getElementById('stat-start-eng').textContent = first.gregFull || `${first.day} ${first.gregDate}`;
  document.getElementById('stat-end-eng').textContent   = last.gregFull  || `${last.day} ${last.gregDate}`;
  document.getElementById('stat-total-notifs').textContent = `${data.days.length * 5} notifications`;
  document.getElementById('stat-days2').textContent = `${data.days.length} days`;
}

function renderNotificationPreview(data, filterDay = 'all') {
  const container = document.getElementById('preview-container');
  container.innerHTML = '';

  const filtered = filterDay === 'all' ? data.days : data.days.filter(d => d.day === filterDay);

  for (const day of filtered) {
    const notes = buildNotifications(day);
    const dayDiv = document.createElement('div');
    dayDiv.className = 'notif-day';

    const engDate = formatEngDate(day);
    dayDiv.innerHTML = `<div class="notif-day-header">${engDate}</div>`;

    for (const n of notes) {
      const card = document.createElement('div');
      card.className = 'notif-card';
      card.innerHTML = `
        <div class="notif-icon">${n.icon}</div>
        <div class="notif-body">
          <div class="notif-firetime">${engDate} Â· ${n.fireTimeFmt} Â· <span style="color:#6a4;">URGENT</span></div>
          <div class="notif-title">${n.title}</div>
          ${n.details ? `<div class="notif-sub">${n.details}</div>` : ''}
          ${n.countdown ? `<div class="notif-countdown">${n.countdown}</div>` : ''}
        </div>
      `;
      dayDiv.appendChild(card);
    }

    container.appendChild(dayDiv);
  }
}

function renderDayFilterTabs(data) {
  const uniqueDays = [...new Set(data.days.map(d => d.day))];
  const tabs = document.getElementById('day-filter-tabs');
  tabs.innerHTML = '';

  const allTab = document.createElement('div');
  allTab.className = 'day-tab active';
  allTab.textContent = 'All';
  allTab.dataset.day = 'all';
  tabs.appendChild(allTab);

  for (const d of DAY_NAMES) {
    if (uniqueDays.includes(d)) {
      const tab = document.createElement('div');
      tab.className = 'day-tab';
      tab.textContent = d;
      tab.dataset.day = d;
      tabs.appendChild(tab);
    }
  }

  tabs.addEventListener('click', e => {
    const tab = e.target.closest('.day-tab');
    if (!tab) return;
    tabs.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    renderNotificationPreview(parsedData, tab.dataset.day);
  });
}

function loadData(data) {
  parsedData = data;
  renderMonthBar(data);
  renderTable(data);
  document.getElementById('data-area').classList.remove('hidden');
  document.getElementById('preview-panel-wrap').classList.add('hidden');
  document.getElementById('raw-json-panel').classList.add('hidden');
  showAlert(`âœ“ Parsed ${data.days.length} days from "${data.title}"`, 'success');
}

function handleCSVText(text) {
  pendingCSVText = text;
  // Show parse mode chooser
  const wrap = document.getElementById('parse-chooser-wrap');
  wrap.classList.remove('hidden');
  document.getElementById('parse-loading').classList.add('hidden');
  wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function scriptParse() {
  if (!pendingCSVText) return;
  document.getElementById('parse-chooser-wrap').classList.add('hidden');
  try {
    const rows = parseCSV(pendingCSVText);
    const data = parsePrayerData(rows);
    loadData(data);
  } catch (err) {
    showAlert(`Parse error: ${err.message}`, 'error');
    console.error(err);
  }
}

async function aiParse() {
  if (!pendingCSVText) return;
  const wrap = document.getElementById('parse-chooser-wrap');
  const loading = document.getElementById('parse-loading');
  const chooser = wrap.querySelector('.parse-chooser');
  chooser.classList.add('hidden');
  loading.classList.remove('hidden');

  try {
    const resp = await fetch('/api/ai-parse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ csv: pendingCSVText }),
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ error: 'unknown' }));
      throw new Error(err.error || `Server error ${resp.status}`);
    }
    const data = await resp.json();
    wrap.classList.add('hidden');
    loadData(data);
    showAlert(`âœ“ AI parsed ${data.days.length} days from "${data.title}"`, 'success');
  } catch (err) {
    loading.classList.add('hidden');
    chooser.classList.remove('hidden');
    showAlert(`AI parse failed: ${err.message}`, 'error');
    console.error(err);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCHEDULED NOTIFICATIONS SECTION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Group notifications by date (gregFull)
function groupByDay(queue) {
  const map = new Map();
  for (const n of queue) {
    const key = n.gregFull || n.fireUTC?.slice(0, 10) || 'Unknown';
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(n);
  }
  return map;
}

function fmtUTCForDisplay(isoStr) {
  if (!isoStr) return 'â€”';
  const d = new Date(isoStr);
  return d.toLocaleString('en-GB', {
    timeZone: 'Europe/London',
    weekday: 'short', day: 'numeric', month: 'short',
    hour: '2-digit', minute: '2-digit', hour12: false,
  }) + ' (UK)';
}

function fmtUTCShort(isoStr) {
  if (!isoStr) return 'â€”';
  const d = new Date(isoStr);
  return d.toLocaleTimeString('en-GB', {
    timeZone: 'Europe/London',
    hour: '2-digit', minute: '2-digit', hour12: false,
  });
}

function renderScheduled(queue) {
  const list = document.getElementById('sched-list');
  const countEl = document.getElementById('sched-count');
  const nowISO = new Date().toISOString();

  if (!queue || queue.length === 0) {
    countEl.textContent = '0 notifications in queue';
    list.innerHTML = `<div class="sched-empty">No notifications scheduled yet.<br><small style="color:#444;margin-top:6px;display:block;">Upload a CSV and press PUSH TO NTFY to schedule.</small></div>`;
    return;
  }

  const upcomingCount = queue.filter(n => (n.fireUTC || '') > nowISO).length;
  const pastCount     = queue.length - upcomingCount;
  countEl.textContent = `${queue.length} total Â· ğŸŸ  ${upcomingCount} scheduled in NTFY Â· ğŸŸ¢ ${pastCount} already fired`;

  const grouped = groupByDay(queue);
  list.innerHTML = '';

  for (const [dayLabel, notifs] of grouped) {
    // Determine past/future: use first notification's fireUTC
    const firstUTC = notifs[0]?.fireUTC || '';
    const isPast = firstUTC && firstUTC <= nowISO;
    const stateClass = isPast ? 'past' : 'upcoming';
    const stateLabel = isPast ? 'âœ“ Already fired' : 'â³ Scheduled â€” queued in NTFY';

    const dayDiv = document.createElement('div');
    dayDiv.className = `sched-day ${stateClass}`;

    const header = document.createElement('div');
    header.className = 'sched-day-header';
    header.innerHTML = `
      <div class="status-dot ${stateClass}"></div>
      <div class="sched-day-label">${dayLabel}</div>
      <div class="sched-day-meta">${notifs.length} notifications Â· ${stateLabel}</div>
      <div class="sched-day-chevron">â–¶</div>
    `;

    const body = document.createElement('div');
    body.className = 'sched-day-body';

    for (const n of notifs) {
      const row = document.createElement('div');
      row.className = 'sched-notif-row';
      const msgLines = [n.details, n.countdown].filter(Boolean).join(' Â· ');
      row.innerHTML = `
        <div class="sched-notif-icon">${n.icon || 'ğŸ””'}</div>
        <div class="sched-notif-info">
          <div class="sched-notif-title">${n.title}</div>
          ${msgLines ? `<div class="sched-notif-detail">${msgLines}</div>` : ''}
        </div>
        <div class="sched-notif-time">
          ${n.fireTimeFmt || 'â€”'}
          <span class="utc">${n.fireUTC ? new Date(n.fireUTC).toISOString().slice(0,16).replace('T',' ') + ' UTC' : ''}</span>
        </div>
      `;
      body.appendChild(row);
    }

    header.addEventListener('click', () => {
      dayDiv.classList.toggle('open');
    });

    dayDiv.appendChild(header);
    dayDiv.appendChild(body);
    list.appendChild(dayDiv);
  }
}

async function fetchAndRenderQueue() {
  try {
    const resp = await fetch('/api/queue');
    if (!resp.ok) throw new Error('Failed to load queue');
    const queue = await resp.json();
    renderScheduled(queue);
  } catch (e) {
    document.getElementById('sched-count').textContent = 'Error loading queue';
    console.error(e);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT WIRING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// File input (click-to-browse)
const fileInput = document.getElementById('csv-file');
const dropZone = document.getElementById('drop-zone');

dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { markAccepted(file.name); handleCSVText(ev.target.result); };
  reader.readAsText(file);
});

// Drag & drop â€” handle on the zone div (input has pointer-events:none)
dropZone.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { markAccepted(file.name); handleCSVText(ev.target.result); };
  reader.readAsText(file);
});

function markAccepted(filename) {
  dropZone.classList.add('accepted');
  dropZone.querySelector('.upload-icon').textContent = 'âœ…';
  dropZone.querySelector('h2').textContent = filename;
  dropZone.querySelector('p').textContent = 'File loaded â€” choose a parse method below';
}

function resetDropZone() {
  dropZone.classList.remove('accepted');
  dropZone.querySelector('.upload-icon').textContent = 'ğŸ“„';
  dropZone.querySelector('h2').textContent = 'Drop your prayer times CSV here';
  dropZone.querySelector('p').textContent = 'or click to browse \u00b7 Accepts MUAI Birmingham format';
}

// Paste toggle
document.getElementById('paste-toggle').addEventListener('click', () => {
  document.getElementById('paste-area').classList.toggle('hidden');
});

document.getElementById('parse-paste-btn').addEventListener('click', () => {
  const text = document.getElementById('csv-paste').value;
  if (!text.trim()) { showAlert('Nothing pasted yet.', 'error'); return; }
  markAccepted('Pasted CSV');
  handleCSVText(text);
});

// Clear
document.getElementById('clear-btn').addEventListener('click', () => {
  parsedData = null;
  pendingCSVText = null;
  document.getElementById('data-area').classList.add('hidden');
  document.getElementById('parse-chooser-wrap').classList.add('hidden');
  document.getElementById('csv-file').value = '';
  document.getElementById('csv-paste').value = '';
  resetDropZone();
});

// Preview notifications
document.getElementById('preview-btn').addEventListener('click', () => {
  if (!parsedData) return;
  renderDayFilterTabs(parsedData);
  renderNotificationPreview(parsedData, 'all');
  document.getElementById('preview-panel-wrap').classList.remove('hidden');
  document.getElementById('preview-panel-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// Raw JSON
document.getElementById('raw-btn').addEventListener('click', () => {
  if (!parsedData) return;
  const panel = document.getElementById('raw-json-panel');
  const content = document.getElementById('raw-json-content');
  if (panel.classList.contains('hidden')) {
    content.textContent = JSON.stringify(parsedData, null, 2);
    panel.classList.remove('hidden');
  } else {
    panel.classList.add('hidden');
  }
});

// PUSH TO NTFY
document.getElementById('push-ntfy-btn').addEventListener('click', async () => {
  if (!parsedData) { showAlert('No CSV loaded â€” nothing to push.', 'error'); return; }

  const btn = document.getElementById('push-ntfy-btn');
  btn.disabled = true;
  btn.textContent = 'â³ Pushingâ€¦';

  try {
    const notifications = buildAllNotifications(parsedData);

    // Filter out notifications with no fireUTC (missing time data)
    const valid = notifications.filter(n => n.fireUTC);
    if (valid.length === 0) {
      showAlert('No valid fire times found â€” cannot push.', 'error');
      return;
    }

    const resp = await fetch('/api/push', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(valid),
    });

    if (!resp.ok) throw new Error(`Server error ${resp.status}`);
    const result = await resp.json();

    const parts = [`âœ“ Pushed ${result.pushed} to NTFY now`];
    if (result.deferred) parts.push(`${result.deferred} deferred (auto-drip)`);
    if (result.skipped)  parts.push(`${result.skipped} past`);
    if (result.failed)   parts.push(`${result.failed} failed`);
    parts.push(`Queue: ${result.queued} total`);
    showAlert(parts.join(' Â· '), result.failed > 0 ? 'info' : 'success');

    // Refresh the scheduled section
    await fetchAndRenderQueue();

    // Scroll to scheduled section
    document.getElementById('section-scheduled').scrollIntoView({ behavior: 'smooth', block: 'start' });

  } catch (e) {
    showAlert(`Push failed: ${e.message}`, 'error');
    console.error(e);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ”´ PUSH TO NTFY';
  }
});

// Delete all future notifications
document.getElementById('delete-future-btn').addEventListener('click', async () => {
  const btn = document.getElementById('delete-future-btn');
  btn.disabled = true;
  btn.textContent = 'â³ Deletingâ€¦';
  try {
    const resp = await fetch('/api/queue/future', { method: 'DELETE' });
    if (!resp.ok) throw new Error(`Server error ${resp.status}`);
    const result = await resp.json();
    showAlert(`âœ“ Deleted ${result.deleted} future notifications. ${result.queue.length} past notifications remain.`, 'success');
    await fetchAndRenderQueue();
  } catch (e) {
    showAlert(`Delete failed: ${e.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ—‘ Delete All Future';
  }
});

// Parse mode chooser
document.getElementById('parse-script').addEventListener('click', scriptParse);
document.getElementById('parse-ai').addEventListener('click', aiParse);

// Check AI availability on load
fetch('/api/ai-available').then(r => r.json()).then(d => {
  aiAvailable = d.available;
  if (aiAvailable) document.getElementById('parse-ai').classList.remove('hidden');
}).catch(() => {});

// Load queue on page start
fetchAndRenderQueue();
</script>
</body>
</html>
