<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MUAI Prayer Times</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #111;
      --surface2: #161616;
      --border: #222;
      --accent: #a08a3c;
      --accent-dim: #5a4e28;
      --text: #ccc;
      --text-muted: #666;
      --fajr: #5b8fa8;
      --sunrise: #c07828;
      --zuhr: #5a9a5a;
      --asr: #b08040;
      --maghrib: #8860a0;
      --isha: #4070b0;
      --green: #2a7a2a;
      --red: #7a2020;
      --orange: #906010;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, 'Segoe UI', system-ui, sans-serif;
      font-size: 13px;
      line-height: 1.5;
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header .logo { font-size: 0.95rem; font-weight: 600; color: var(--text); letter-spacing: 0.02em; }
    header .logo span { color: var(--accent); }
    header .subtitle { color: var(--text-muted); font-size: 0.7rem; }

    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ── Upload zone ── */
    .upload-zone {
      border: 1px dashed #3a1818; border-radius: 6px; padding: 24px;
      text-align: center; background: #120c0c; cursor: pointer;
      transition: border-color 0.2s, background 0.2s; position: relative;
    }
    .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: #14120a; }
    .upload-zone.accepted { border-color: var(--green); border-style: solid; background: #0c140c; }
    .upload-zone input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer;
      width: 100%; height: 100%; pointer-events: none;
    }
    .upload-icon { font-size: 1.2rem; margin-bottom: 6px; color: var(--text-muted); }
    .upload-zone h2 { font-size: 0.82rem; font-weight: 500; color: var(--text); margin-bottom: 2px; }
    .upload-zone p { color: var(--text-muted); font-size: 0.72rem; }

    /* ── Buttons ── */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; border-radius: 4px; border: 1px solid var(--border);
      font-size: 0.75rem; font-weight: 500; cursor: pointer;
      transition: opacity 0.12s; background: var(--surface2); color: var(--text);
    }
    .btn:hover { opacity: 0.8; }
    .btn:active { opacity: 0.7; }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .btn-primary { background: var(--accent-dim); color: #ddd; border-color: var(--accent-dim); }
    .btn-secondary { background: var(--surface2); color: var(--text-muted); border-color: var(--border); }
    .btn-danger { background: #1a0e0e; color: #c06060; border-color: #3a1818; }
    .btn-ntfy { background: var(--red); color: #e0c0c0; border-color: #4a1a1a; font-weight: 600; letter-spacing: 0.03em; }
    .btn.active { background: var(--accent-dim); color: #ddd; border-color: var(--accent); }

    /* ── Month info bar ── */
    .month-bar {
      background: var(--surface); border: 1px solid var(--border); border-radius: 4px;
      padding: 10px 14px; margin-bottom: 12px;
      display: flex; align-items: center; gap: 14px; flex-wrap: wrap; font-size: 0.78rem;
    }
    .month-bar .month-title { font-weight: 600; color: var(--accent); }
    .month-bar .stats { display: flex; gap: 12px; color: var(--text-muted); }
    .month-bar .stats span strong { color: var(--text); }

    .actions-bar { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }

    /* ── Prayer times table ── */
    .table-wrap { overflow-x: auto; border-radius: 4px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 0.74rem; min-width: 800px; }
    thead th {
      background: var(--surface); padding: 6px 5px; text-align: center;
      font-weight: 600; border-bottom: 1px solid var(--border); white-space: nowrap; font-size: 0.7rem;
    }
    thead .th-group { font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
    thead .th-fajr { color: var(--fajr); }
    thead .th-sunrise { color: var(--sunrise); }
    thead .th-zuhr { color: var(--zuhr); }
    thead .th-asr { color: var(--asr); }
    thead .th-maghrib { color: var(--maghrib); }
    thead .th-isha { color: var(--isha); }
    tbody tr { border-bottom: 1px solid #1a1a1a; }
    tbody tr:hover { background: #141414; }
    tbody tr.row-fri { background: #111a0e; border-left: 2px solid #3a6a20; }
    tbody tr.row-fri:hover { background: #162010; }
    tbody tr.row-sat, tbody tr.row-sun { background: #0e1018; }
    tbody td { padding: 5px 5px; text-align: center; white-space: nowrap; }
    .col-day { font-weight: 600; font-size: 0.72rem; }
    .col-day.fri { color: #5a8f2a; }
    .col-day.sat, .col-day.sun { color: #5080b0; }
    .col-date-hijri { color: var(--accent); font-weight: 500; font-size: 0.72rem; }
    .col-date-greg { color: var(--text-muted); font-size: 0.7rem; }
    .time-cell { font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; font-size: 0.74rem; }
    .jamat-cell { font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; font-size: 0.74rem; font-weight: 600; }
    .fajr-time { color: var(--fajr); } .fajr-jamat { color: #80b8d0; }
    .sunrise-time { color: var(--sunrise); }
    .zuhr-time { color: var(--zuhr); } .zuhr-jamat { color: #80c080; }
    .asr-time { color: var(--asr); } .asr-jamat { color: #c0a060; }
    .maghrib-time { color: var(--maghrib); } .maghrib-jamat { color: #a080b8; }
    .isha-time { color: var(--isha); } .isha-jamat { color: #6090c0; }
    .cell-empty { color: #282828; }

    /* ── Notification preview ── */
    .preview-panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 4px; padding: 14px;
    }
    .notif-day { margin-bottom: 14px; }
    .notif-day-header {
      font-size: 0.7rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.08em;
      margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--border);
    }
    .notif-card {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 3px;
      padding: 7px 10px; margin-bottom: 4px; display: flex; align-items: flex-start; gap: 8px;
    }
    .notif-icon { font-size: 0.82rem; flex-shrink: 0; }
    .notif-body { flex: 1; }
    .notif-title { font-size: 0.76rem; font-weight: 500; color: var(--text); }
    .notif-sub { font-size: 0.7rem; color: var(--text-muted); }
    .notif-countdown { font-size: 0.7rem; color: var(--accent); margin-top: 2px; }
    .notif-firetime { font-size: 0.62rem; color: #444; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.04em; }

    /* ── Day filter tabs ── */
    .day-filter { display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; }
    .day-tab {
      padding: 3px 10px; border-radius: 3px; border: 1px solid var(--border);
      background: transparent; color: var(--text-muted); font-size: 0.7rem;
      cursor: pointer; transition: all 0.12s;
    }
    .day-tab:hover, .day-tab.active { background: var(--accent-dim); color: var(--text); border-color: var(--accent-dim); }

    /* ── Pagination ── */
    .pagination {
      display: flex; align-items: center; justify-content: center;
      gap: 12px; padding: 14px 0; margin-top: 10px;
    }
    .pagination .btn { min-width: 70px; justify-content: center; }
    .pagination .page-label { font-size: 0.72rem; color: var(--text-muted); }

    /* ── Section header for inline panels ── */
    .panel-header {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 0 8px; margin-top: 16px;
      border-top: 1px solid var(--border);
    }
    .panel-header .panel-title { font-size: 0.78rem; font-weight: 600; color: var(--text); }
    .panel-header .panel-info { font-size: 0.7rem; color: var(--text-muted); margin-left: auto; }

    /* ── Alerts ── */
    .alert { padding: 8px 12px; border-radius: 3px; margin-bottom: 12px; font-size: 0.76rem; }
    .alert-error { background: #180c0c; border: 1px solid #3a1818; color: #c08080; }
    .alert-success { background: #0c180c; border: 1px solid #183a18; color: #80c080; }
    .alert-info { background: #0c0e18; border: 1px solid #18283a; color: #80a0c0; }

    .hidden { display: none !important; }
    .section { margin-bottom: 20px; }
    .section-title {
      font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 8px;
    }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #222; border-radius: 2px; }

    .raw-toggle { font-size: 0.68rem; color: var(--text-muted); cursor: pointer; text-decoration: underline; margin-left: auto; }
    .raw-panel {
      background: #080808; border: 1px solid var(--border); border-radius: 3px; padding: 10px;
      font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; font-size: 0.68rem;
      color: #555; white-space: pre-wrap; word-break: break-all; max-height: 180px;
      overflow-y: auto; margin-top: 8px;
    }

    /* ── Scheduled Notifications ── */
    .sched-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
    .sched-header .sched-title { font-size: 0.82rem; font-weight: 600; color: var(--text); }
    .sched-header .sched-count { font-size: 0.72rem; color: var(--text-muted); }
    .sched-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
    .sched-empty {
      text-align: center; color: var(--text-muted); font-size: 0.76rem;
      padding: 24px; border: 1px dashed var(--border); border-radius: 4px;
    }
    .sched-day { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 4px; overflow: hidden; }
    .sched-day-header {
      display: flex; align-items: center; gap: 10px; padding: 7px 12px;
      cursor: pointer; user-select: none; transition: background 0.1s; font-size: 0.76rem;
    }
    .sched-day-header:hover { background: #141414; }
    .sched-day.past .sched-day-header { background: #0c140c; border-left: 2px solid var(--green); }
    .sched-day.past .sched-day-header:hover { background: #0e180e; }
    .sched-day.upcoming .sched-day-header { background: #14100a; border-left: 2px solid var(--orange); }
    .sched-day.upcoming .sched-day-header:hover { background: #18140c; }
    .sched-day-label { font-size: 0.78rem; font-weight: 600; color: var(--text); flex: 1; }
    .sched-day.past .sched-day-label { color: #60b060; }
    .sched-day.upcoming .sched-day-label { color: #c09030; }
    .sched-day-meta { font-size: 0.66rem; color: var(--text-muted); }
    .sched-day-chevron { font-size: 0.6rem; color: var(--text-muted); transition: transform 0.15s; }
    .sched-day.open .sched-day-chevron { transform: rotate(90deg); }
    .sched-day-body { display: none; padding: 8px 12px 10px; background: #0c0c0c; border-top: 1px solid var(--border); }
    .sched-day.open .sched-day-body { display: block; }
    .sched-notif-row { display: flex; align-items: flex-start; gap: 8px; padding: 5px 0; border-bottom: 1px solid #161616; font-size: 0.74rem; }
    .sched-notif-row:last-child { border-bottom: none; }
    .sched-notif-icon { font-size: 0.78rem; flex-shrink: 0; width: 20px; text-align: center; }
    .sched-notif-info { flex: 1; }
    .sched-notif-title { font-size: 0.74rem; font-weight: 500; color: var(--text); }
    .sched-notif-detail { font-size: 0.66rem; color: var(--text-muted); margin-top: 1px; }
    .sched-notif-time { font-size: 0.66rem; color: #444; text-align: right; white-space: nowrap; }
    .sched-notif-time .utc { display: block; font-size: 0.6rem; color: #333; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
    .status-dot.past { background: var(--green); }
    .status-dot.upcoming { background: var(--orange); }

    /* ── Parse Mode Chooser ── */
    .parse-chooser { display: flex; gap: 8px; margin-top: 8px; }
    .parse-option {
      flex: 1; background: transparent; border: 1px solid var(--border); border-radius: 4px;
      padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 8px;
      transition: all 0.12s;
    }
    .parse-option:hover { border-color: #3a3a3a; background: #141414; }
    .parse-option-icon { font-size: 0.78rem; flex-shrink: 0; color: var(--text-muted); }
    .parse-option-title { font-size: 0.76rem; font-weight: 500; color: var(--text); }
    .parse-option-desc { font-size: 0.64rem; color: #444; margin-top: 1px; }
    .parse-option.ai { border-color: #1e1a12; }
    .parse-option.ai:hover { border-color: var(--accent-dim); background: #12100a; }
    .parse-option.ai .parse-option-title { color: var(--accent); }
    .parse-loading { text-align: center; padding: 16px; color: #555; font-size: 0.76rem; }
    .parse-loading .spinner {
      display: inline-block; width: 12px; height: 12px; border: 1.5px solid #222;
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-right: 6px; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .date-range-bar {
      background: var(--surface); border: 1px solid var(--border); border-radius: 4px;
      padding: 8px 14px; font-size: 0.72rem; color: var(--text-muted);
      display: flex; gap: 6px; align-items: center; flex-wrap: wrap; margin-top: 8px;
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="logo"><span>MUAI</span> Prayer Times</div>
    <div class="subtitle">Birmingham Islamic Prayer Notification System</div>
  </div>
  <a href="/logout" style="margin-left:auto;font-size:0.68rem;color:#444;text-decoration:none;padding:4px 10px;border:1px solid #222;border-radius:3px;" onmouseover="this.style.color='#999'" onmouseout="this.style.color='#444'">Sign out</a>
</header>

<div class="main">

  <div class="section" id="section-upload">
    <div class="section-title">Import CSV</div>
    <div class="upload-zone" id="drop-zone">
      <input type="file" id="csv-file" accept=".csv" />
      <div class="upload-icon"></div>
      <h2>Drop your prayer times CSV here</h2>
      <p>or click to browse</p>
    </div>
    <div style="margin-top:6px; text-align:right;">
      <span class="raw-toggle" id="paste-toggle">or paste CSV text</span>
    </div>
    <div id="paste-area" class="hidden" style="margin-top:8px;">
      <textarea id="csv-paste" rows="4" style="width:100%;background:#080808;color:#666;border:1px solid var(--border);border-radius:3px;padding:8px;font-family:'SF Mono','Consolas',monospace;font-size:0.7rem;resize:vertical;" placeholder="Paste CSV content here..."></textarea>
      <button class="btn btn-secondary" style="margin-top:6px;" id="parse-paste-btn">Parse pasted CSV</button>
    </div>
  </div>

  <div id="parse-chooser-wrap" class="section hidden">
    <div class="section-title">Parse method</div>
    <div class="parse-chooser">
      <div class="parse-option" id="parse-script">
        <div class="parse-option-icon">&gt;_</div>
        <div>
          <div class="parse-option-title">Script Parse</div>
          <div class="parse-option-desc">Standard MUAI format</div>
        </div>
      </div>
      <div class="parse-option ai hidden" id="parse-ai">
        <div class="parse-option-icon">AI</div>
        <div>
          <div class="parse-option-title">AI Parse</div>
          <div class="parse-option-desc">Any CSV format</div>
        </div>
      </div>
    </div>
    <div id="parse-loading" class="parse-loading hidden">
      <span class="spinner"></span> AI is reading your timetable...
    </div>
  </div>

  <div id="alert-area"></div>

  <div id="data-area" class="hidden">
    <div class="section">
      <div class="section-title">Parsed Month</div>
      <div class="month-bar">
        <div class="month-title" id="month-title">&mdash;</div>
        <div class="stats">
          <span><strong id="stat-days">0</strong> days</span>
          <span><strong id="stat-fri">0</strong> Fri</span>
        </div>
        <button class="btn btn-secondary" id="clear-btn" style="margin-left:auto;">Clear</button>
      </div>
      <div class="date-range-bar" id="date-range-bar">
        <span style="color:#444">Range:</span>
        <span id="stat-start-eng" style="color:var(--text);font-weight:500;">&mdash;</span>
        <span style="color:#333">&rarr;</span>
        <span id="stat-end-eng" style="color:var(--text);font-weight:500;">&mdash;</span>
        <span style="color:#333;margin-left:6px;">&middot;</span>
        <span id="stat-total-notifs" style="color:var(--accent);font-weight:600;">0 notifications</span>
        <span style="color:#333">across</span>
        <span id="stat-days2" style="color:var(--accent);font-weight:600;">0 days</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Actions</div>
      <div class="actions-bar">
        <button class="btn btn-primary" id="preview-btn">Preview</button>
        <button class="btn btn-ntfy" id="push-ntfy-btn">Schedule</button>
        <button class="btn btn-secondary" id="raw-btn">Raw JSON</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Prayer Times</div>
      <div class="table-wrap">
        <table id="prayer-table">
          <thead>
            <tr>
              <th rowspan="2" style="min-width:36px;">Day</th>
              <th rowspan="2" style="min-width:32px;">Hijri</th>
              <th rowspan="2" style="min-width:44px;">Date</th>
              <th colspan="2" class="th-group th-fajr">Fajr</th>
              <th rowspan="2" class="th-group th-sunrise">Sunrise</th>
              <th colspan="2" class="th-group th-zuhr">Zuhr</th>
              <th colspan="2" class="th-group th-asr">Asr</th>
              <th colspan="2" class="th-group th-maghrib">Maghrib</th>
              <th colspan="2" class="th-group th-isha">Isha</th>
            </tr>
            <tr>
              <th class="th-fajr">Start</th>
              <th class="th-fajr">Jamat</th>
              <th class="th-zuhr">Start</th>
              <th class="th-zuhr">Jamat</th>
              <th class="th-asr">Start</th>
              <th class="th-asr">Jamat</th>
              <th class="th-maghrib">Adhan</th>
              <th class="th-maghrib">Jamat</th>
              <th class="th-isha">Start</th>
              <th class="th-isha">Jamat</th>
            </tr>
          </thead>
          <tbody id="prayer-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="raw-json-panel" class="hidden section">
      <div class="section-title">Raw Parsed JSON</div>
      <div class="raw-panel" id="raw-json-content"></div>
    </div>

    <!-- Notification Preview (inline, toggled by Preview button) -->
    <div id="section-preview" class="hidden section">
      <div class="panel-header">
        <div class="panel-title">Notification Preview</div>
        <div class="panel-info" id="preview-page-info"></div>
      </div>
      <div class="day-filter" id="day-filter-tabs"></div>
      <div class="preview-panel" id="preview-container"></div>
      <div class="pagination">
        <button class="btn btn-secondary" id="preview-prev">Prev</button>
        <span class="page-label" id="preview-page-label"></span>
        <button class="btn btn-secondary" id="preview-next">Next</button>
      </div>
    </div>

  </div>

  <!-- Queue — always visible, syncs across all users -->
  <div id="section-queue" class="section" style="margin-top: 20px;">
    <div class="section-title">Notification Queue</div>
    <div id="alert-area-queue"></div>
    <div class="sched-header">
      <div>
        <div class="sched-title">Scheduled</div>
        <div class="sched-count" id="sched-count">Loading...</div>
      </div>
      <div class="sched-actions">
        <button class="btn btn-danger" id="delete-future-btn">Delete future</button>
      </div>
    </div>
    <div id="sched-list"></div>
  </div>

</div>

<script>
// ─────────────────────────────────────────────
// CSV PARSER
// ─────────────────────────────────────────────

function parseCSV(text) {
  const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');

  function splitLine(line) {
    const fields = [];
    let cur = '';
    let inQuote = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuote && line[i + 1] === '"') { cur += '"'; i++; }
        else { inQuote = !inQuote; }
      } else if (ch === ',' && !inQuote) {
        fields.push(cur.trim());
        cur = '';
      } else {
        cur += ch;
      }
    }
    fields.push(cur.trim());
    return fields;
  }

  const joinedLines = [];
  let buffer = '';
  let quoteCount = 0;
  for (const line of lines) {
    quoteCount += (line.match(/"/g) || []).length;
    buffer += (buffer ? '\n' : '') + line;
    if (quoteCount % 2 === 0) {
      joinedLines.push(buffer);
      buffer = '';
    }
  }
  if (buffer) joinedLines.push(buffer);

  return joinedLines.map(splitLine);
}

function extractMonthTitle(rows) {
  const ISLAMIC_MONTHS = [
    'muharram','safar','rabi al-awwal','rabi al-thani','rabi ul awwal','rabi ul thani',
    'jumada al-awwal','jumada al-thani','jumada ul awwal','jumada ul thani',
    'rajab','sha\'ban','shaban','ramadan','ramadhan','shawwal',
    'dhul qadah','dhul hijjah','rabi','jumada'
  ];

  for (const row of rows.slice(0, 8)) {
    for (const cell of row) {
      if (!cell) continue;
      const lower = cell.toLowerCase().replace(/\n/g,' ').trim();
      for (const m of ISLAMIC_MONTHS) {
        if (lower.includes(m)) return cell.replace(/\n/g, ' ').trim();
      }
    }
  }

  for (const row of rows.slice(0, 8)) {
    for (const cell of row) {
      if (cell && cell.trim().length > 3 && !cell.includes(',') && !/\d/.test(cell)) {
        const words = cell.trim().split(/\s+/);
        if (words.length <= 3) return cell.replace(/\n/g, ' ').trim();
      }
    }
  }

  return 'Birmingham Prayer Times';
}

const DAY_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

function normaliseDay(cell) {
  if (!cell) return '';
  const s = cell.trim().toLowerCase();
  return DAY_NAMES.find(d => d.toLowerCase() === s) || '';
}

function findDataStart(rows) {
  for (let i = 0; i < rows.length; i++) {
    if (normaliseDay(rows[i][1])) return i;
  }
  return -1;
}

function resolveTime(value, lastValue) {
  if (!value || value === '' || value === '"') return lastValue;
  return value;
}

function parsePrayerData(rows) {
  const title = extractMonthTitle(rows);
  const dataStart = findDataStart(rows);
  if (dataStart === -1) throw new Error('Could not find prayer time data rows. Is this the right CSV format?');

  const days = [];
  const last = { fajrJamat: '', zuhrJamat: '', asrJamat: '', maghribJamat: '', ishaJamat: '' };

  const GREG_MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const GREG_MONTH_LOWER = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];

  function matchMonth(cell) {
    const s = (cell || '').trim().toLowerCase();
    if (!s) return -1;
    const exact = GREG_MONTH_LOWER.indexOf(s);
    if (exact !== -1) return exact;
    for (let i = 0; i < GREG_MONTH_LOWER.length; i++) {
      if (s.startsWith(GREG_MONTH_LOWER[i])) return i;
    }
    return -1;
  }

  let runningMonth = -1;
  let runningYear  = new Date().getFullYear();
  let runningDay   = 0;

  for (let i = 0; i < dataStart; i++) {
    for (const cell of rows[i]) {
      const mi = matchMonth(cell);
      if (mi !== -1) { runningMonth = mi; break; }
    }
    if (runningMonth !== -1) break;
  }

  if (runningMonth === -1) {
    for (let i = dataStart; i < rows.length; i++) {
      const cell = (rows[i][3] || '').trim();
      const mi = matchMonth(cell);
      if (mi !== -1) {
        runningMonth = mi === 0 ? 11 : mi - 1;
        if (mi === 0) runningYear--;
        break;
      }
    }
  }

  for (let i = dataStart; i < rows.length; i++) {
    const r = rows[i];
    const dayName = normaliseDay(r[1]);

    if (!dayName) {
      const mi = matchMonth(r[3]);
      if (mi !== -1) runningMonth = mi;
      continue;
    }

    const gregRaw = (r[3] || '').trim();
    const gregMonthIdx = matchMonth(gregRaw);

    let gregDayNum;
    if (gregMonthIdx !== -1) {
      runningMonth = gregMonthIdx;
      runningDay   = 1;
      gregDayNum   = 1;
    } else {
      const parsed = parseInt(gregRaw);
      if (!isNaN(parsed)) {
        gregDayNum = parsed;
        runningDay = parsed;
      } else {
        runningDay++;
        const daysInMonth = new Date(runningYear, runningMonth + 1, 0).getDate();
        if (runningDay > daysInMonth) {
          runningDay = 1;
          runningMonth = (runningMonth + 1) % 12;
          if (runningMonth === 0) runningYear++;
        }
        gregDayNum = runningDay;
      }
    }

    const gregMonthStr = GREG_MONTH_NAMES[runningMonth] || '?';
    const gregFull = `${dayName}, ${gregDayNum} ${gregMonthStr} ${runningYear}`;
    const gregYear  = runningYear;
    const gregMonth = runningMonth;
    const gregDay   = gregDayNum;

    const fajrJamat    = resolveTime(r[5],  last.fajrJamat);
    const zuhrJamat    = resolveTime(r[8],  last.zuhrJamat);
    const asrJamat     = resolveTime(r[10], last.asrJamat);
    const maghribJamat = resolveTime(r[12], last.maghribJamat);
    const ishaJamat    = resolveTime(r[14], last.ishaJamat);

    last.fajrJamat = fajrJamat; last.zuhrJamat = zuhrJamat; last.asrJamat = asrJamat;
    last.maghribJamat = maghribJamat; last.ishaJamat = ishaJamat;

    days.push({
      day: dayName, hijriDate: r[2] || '', gregDate: gregRaw, gregFull, gregYear, gregMonth, gregDay,
      fajrStart: r[4] || '', fajrJamat, sunrise: r[6] || '',
      zuhrStart: r[7] || '', zuhrJamat, asrStart: r[9] || '', asrJamat,
      maghribAdhan: r[11] || '', maghribJamat, ishaStart: r[13] || '', ishaJamat,
    });
  }

  if (days.length === 0) throw new Error('No prayer day rows found. Check CSV structure.');
  return { title, days };
}

// ─────────────────────────────────────────────
// TIME UTILITIES
// ─────────────────────────────────────────────

function timeTo24(t) {
  if (!t) return null;
  const parts = t.match(/^(\d+):(\d+)$/);
  if (!parts) return null;
  return { h: parseInt(parts[1]), m: parseInt(parts[2]) };
}

function resolveSequential(times) {
  let prev = 0;
  return times.map(t => {
    if (!t) return null;
    let mins = t.h * 60 + t.m;
    if (mins < prev) mins += 12 * 60;
    prev = mins;
    return mins;
  });
}

function minutesBetween(fromMins, toMins) {
  if (fromMins === null || toMins === null) return null;
  return toMins - fromMins;
}

function formatDiff(mins) {
  if (mins === null || mins < 0) return null;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  if (h === 0) return `${m}m`;
  if (m === 0) return `${h}h`;
  return `${h}h ${m}m`;
}

function fmtTime(t) {
  if (!t) return '\u2014';
  const p = timeTo24(t);
  if (!p) return t;
  const ampm = p.h < 12 ? 'AM' : 'PM';
  const h = p.h % 12 || 12;
  const m = String(p.m).padStart(2, '0');
  return `${h}:${m} ${ampm}`;
}

function resolvedMinsToUTC(gregYear, gregMonth, gregDay, resolvedMins) {
  const totalMins = resolvedMins % (24 * 60);
  const h = Math.floor(totalMins / 60);
  const m = totalMins % 60;
  const guessUTC = Date.UTC(gregYear, gregMonth, gregDay, h, m, 0, 0);
  const londonParts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/London', hour: 'numeric', minute: 'numeric', hour12: false,
  }).formatToParts(new Date(guessUTC));
  const londonH = parseInt(londonParts.find(p => p.type === 'hour').value);
  const londonM = parseInt(londonParts.find(p => p.type === 'minute').value);
  const offsetMins = (londonH * 60 + londonM) - (h * 60 + m);
  const utcMs = guessUTC - offsetMins * 60 * 1000;
  return new Date(utcMs).toISOString();
}

// ─────────────────────────────────────────────
// NOTIFICATION BUILDER
// ─────────────────────────────────────────────

function formatEngDate(day) {
  return day.gregFull || `${day.day} ${day.gregDate}`;
}

function buildNotifications(day) {
  const rawAdhan = [timeTo24(day.fajrStart), timeTo24(day.sunrise), timeTo24(day.zuhrStart), timeTo24(day.asrStart), timeTo24(day.maghribAdhan), timeTo24(day.ishaStart)];
  const [fajrM, sunriseM, zuhrM, asrM, maghribM, ishaM] = resolveSequential(rawAdhan);

  const rawJamat = [timeTo24(day.fajrJamat), null, timeTo24(day.zuhrJamat), timeTo24(day.asrJamat), timeTo24(day.maghribJamat), timeTo24(day.ishaJamat)];
  const [fajrJM, , zuhrJM, asrJM, maghribJM, ishaJM] = resolveSequential(rawJamat);

  function getFireUTC(m) { return m === null ? null : resolvedMinsToUTC(day.gregYear, day.gregMonth, day.gregDay, m); }
  function jamatDetail(adhanM, jamatM, jamatStr) {
    if (!jamatStr) return '';
    const diff = formatDiff(minutesBetween(adhanM, jamatM));
    return diff ? `${diff} until Jamat \u00b7 ${fmtTime(jamatStr)}` : `Jamat at ${fmtTime(jamatStr)}`;
  }

  const notifs = [];

  // Fajr Adhan
  notifs.push({ icon: '\ud83d\udd4b', title: 'Fajr has begun', details: jamatDetail(fajrM, fajrJM, day.fajrJamat), fireTimeFmt: fmtTime(day.fajrStart), fireUTC: getFireUTC(fajrM) });
  // Fajr Jamat
  if (day.fajrJamat) notifs.push({ icon: '\ud83d\udd4b', title: 'Fajr Jamat', details: 'Congregation starting now', fireTimeFmt: fmtTime(day.fajrJamat), fireUTC: getFireUTC(fajrJM) });

  // Sunrise
  notifs.push({ icon: '\ud83c\udf05', title: 'Sunrise', details: '', fireTimeFmt: fmtTime(day.sunrise), fireUTC: getFireUTC(sunriseM) });

  // Zuhr Adhan
  const zuhrLabel = day.day === 'Fri' ? 'Zuhr has begun \u00b7 Jumu\'ah' : 'Zuhr has begun';
  notifs.push({ icon: '\u2600\ufe0f', title: zuhrLabel, details: jamatDetail(zuhrM, zuhrJM, day.zuhrJamat), fireTimeFmt: fmtTime(day.zuhrStart), fireUTC: getFireUTC(zuhrM) });
  // Zuhr Jamat
  if (day.zuhrJamat) notifs.push({ icon: '\u2600\ufe0f', title: 'Zuhr Jamat', details: 'Congregation starting now', fireTimeFmt: fmtTime(day.zuhrJamat), fireUTC: getFireUTC(zuhrJM) });

  // Asr Adhan
  notifs.push({ icon: '\u26c5', title: 'Asr has begun', details: jamatDetail(asrM, asrJM, day.asrJamat), fireTimeFmt: fmtTime(day.asrStart), fireUTC: getFireUTC(asrM) });
  // Asr Jamat
  if (day.asrJamat) notifs.push({ icon: '\u26c5', title: 'Asr Jamat', details: 'Congregation starting now', fireTimeFmt: fmtTime(day.asrJamat), fireUTC: getFireUTC(asrJM) });

  // Maghrib Adhan
  notifs.push({ icon: '\ud83c\udf07', title: 'Maghrib has begun', details: jamatDetail(maghribM, maghribJM, day.maghribJamat), fireTimeFmt: fmtTime(day.maghribAdhan), fireUTC: getFireUTC(maghribM) });
  // Maghrib Jamat
  if (day.maghribJamat && day.maghribJamat !== day.maghribAdhan) notifs.push({ icon: '\ud83c\udf07', title: 'Maghrib Jamat', details: 'Congregation starting now', fireTimeFmt: fmtTime(day.maghribJamat), fireUTC: getFireUTC(maghribJM) });

  // Isha Adhan
  notifs.push({ icon: '\ud83c\udf19', title: 'Isha has begun', details: jamatDetail(ishaM, ishaJM, day.ishaJamat), fireTimeFmt: fmtTime(day.ishaStart), fireUTC: getFireUTC(ishaM) });
  // Isha Jamat
  if (day.ishaJamat) notifs.push({ icon: '\ud83c\udf19', title: 'Isha Jamat', details: 'Congregation starting now', fireTimeFmt: fmtTime(day.ishaJamat), fireUTC: getFireUTC(ishaJM) });

  return notifs.map(n => ({
    icon: n.icon, title: n.title, details: n.details, countdown: null,
    fireTimeFmt: n.fireTimeFmt, fireUTC: n.fireUTC, priority: 'urgent', gregFull: day.gregFull,
  }));
}

function buildAllNotifications(data) {
  const all = [];
  for (const day of data.days) for (const n of buildNotifications(day)) all.push(n);
  return all;
}

// ─────────────────────────────────────────────
// DOM RENDERING
// ─────────────────────────────────────────────

let parsedData = null;
let pendingCSVText = null;
let aiAvailable = false;
let previewPage = 0;
let previewFilter = 'all';
const DAYS_PER_PAGE = 7;

function showAlert(msg, type = 'info') {
  const el = document.getElementById('alert-area');
  el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => { el.innerHTML = ''; }, 6000);
}

function renderTable(data) {
  const tbody = document.getElementById('prayer-tbody');
  tbody.innerHTML = '';
  for (const d of data.days) {
    const tr = document.createElement('tr');
    const isDay = d.day.toLowerCase();
    if (isDay === 'fri') tr.className = 'row-fri';
    else if (isDay === 'sat') tr.className = 'row-sat';
    else if (isDay === 'sun') tr.className = 'row-sun';
    const dayClass = ['fri','sat','sun'].includes(isDay) ? isDay : '';
    function tc(val, cls) { return `<td class="time-cell ${cls}">${val || '<span class="cell-empty">\u2014</span>'}</td>`; }
    function jc(val, cls) { return `<td class="jamat-cell ${cls}">${val || '<span class="cell-empty">\u2014</span>'}</td>`; }
    tr.innerHTML = `
      <td class="col-day ${dayClass}">${d.day}</td>
      <td class="col-date-hijri">${d.hijriDate}</td>
      <td class="col-date-greg">${d.gregDate}</td>
      ${tc(d.fajrStart,'fajr-time')} ${jc(d.fajrJamat,'fajr-jamat')}
      ${tc(d.sunrise,'sunrise-time')}
      ${tc(d.zuhrStart,'zuhr-time')} ${jc(d.zuhrJamat,'zuhr-jamat')}
      ${tc(d.asrStart,'asr-time')} ${jc(d.asrJamat,'asr-jamat')}
      ${tc(d.maghribAdhan,'maghrib-time')} ${jc(d.maghribJamat,'maghrib-jamat')}
      ${tc(d.ishaStart,'isha-time')} ${jc(d.ishaJamat,'isha-jamat')}
    `;
    tbody.appendChild(tr);
  }
}

function renderMonthBar(data) {
  document.getElementById('month-title').textContent = data.title;
  document.getElementById('stat-days').textContent = data.days.length;
  document.getElementById('stat-fri').textContent = data.days.filter(d => d.day === 'Fri').length;
  const first = data.days[0];
  const last = data.days[data.days.length - 1];
  document.getElementById('stat-start-eng').textContent = first.gregFull || `${first.day} ${first.gregDate}`;
  document.getElementById('stat-end-eng').textContent = last.gregFull || `${last.day} ${last.gregDate}`;
  const totalNotifs = data.days.reduce((sum, d) => sum + buildNotifications(d).length, 0);
  document.getElementById('stat-total-notifs').textContent = `${totalNotifs} notifications`;
  document.getElementById('stat-days2').textContent = `${data.days.length} days`;
}

// ── Preview with pagination ──

function getFilteredDays() {
  if (!parsedData) return [];
  return previewFilter === 'all' ? parsedData.days : parsedData.days.filter(d => d.day === previewFilter);
}

function renderPreviewPage() {
  const filtered = getFilteredDays();
  const totalPages = Math.max(1, Math.ceil(filtered.length / DAYS_PER_PAGE));
  if (previewPage >= totalPages) previewPage = totalPages - 1;
  if (previewPage < 0) previewPage = 0;

  const start = previewPage * DAYS_PER_PAGE;
  const pageDays = filtered.slice(start, start + DAYS_PER_PAGE);

  const container = document.getElementById('preview-container');
  container.innerHTML = '';

  for (const day of pageDays) {
    const notes = buildNotifications(day);
    const dayDiv = document.createElement('div');
    dayDiv.className = 'notif-day';
    const engDate = formatEngDate(day);
    dayDiv.innerHTML = `<div class="notif-day-header">${engDate}</div>`;
    for (const n of notes) {
      const card = document.createElement('div');
      card.className = 'notif-card';
      card.innerHTML = `
        <div class="notif-icon">${n.icon}</div>
        <div class="notif-body">
          <div class="notif-firetime">${engDate} \u00b7 ${n.fireTimeFmt}</div>
          <div class="notif-title">${n.title}</div>
          ${n.details ? `<div class="notif-sub">${n.details}</div>` : ''}
          ${n.countdown ? `<div class="notif-countdown">${n.countdown}</div>` : ''}
        </div>
      `;
      dayDiv.appendChild(card);
    }
    container.appendChild(dayDiv);
  }

  // Update page info
  const startDay = start + 1;
  const endDay = Math.min(start + DAYS_PER_PAGE, filtered.length);
  document.getElementById('preview-page-info').textContent = `Days ${startDay}\u2013${endDay} of ${filtered.length}`;
  document.getElementById('preview-page-label').textContent = `Page ${previewPage + 1} of ${totalPages}`;
  document.getElementById('preview-prev').disabled = previewPage === 0;
  document.getElementById('preview-next').disabled = previewPage >= totalPages - 1;
}

function renderDayFilterTabs() {
  const uniqueDays = [...new Set(parsedData.days.map(d => d.day))];
  const tabs = document.getElementById('day-filter-tabs');
  tabs.innerHTML = '';

  const allTab = document.createElement('div');
  allTab.className = 'day-tab' + (previewFilter === 'all' ? ' active' : '');
  allTab.textContent = 'All';
  allTab.dataset.day = 'all';
  tabs.appendChild(allTab);

  for (const d of DAY_NAMES) {
    if (uniqueDays.includes(d)) {
      const tab = document.createElement('div');
      tab.className = 'day-tab' + (previewFilter === d ? ' active' : '');
      tab.textContent = d;
      tab.dataset.day = d;
      tabs.appendChild(tab);
    }
  }

  tabs.onclick = e => {
    const tab = e.target.closest('.day-tab');
    if (!tab) return;
    tabs.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    previewFilter = tab.dataset.day;
    previewPage = 0;
    renderPreviewPage();
  };
}

// ── Toggle inline sections ──

function toggleSection(id, btn) {
  const el = document.getElementById(id);
  const isVisible = !el.classList.contains('hidden');
  if (isVisible) {
    el.classList.add('hidden');
    if (btn) btn.classList.remove('active');
  } else {
    el.classList.remove('hidden');
    if (btn) btn.classList.add('active');
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// ── Remaining renderers ──

function loadData(data) {
  parsedData = data;
  renderMonthBar(data);
  renderTable(data);
  document.getElementById('data-area').classList.remove('hidden');
  document.getElementById('raw-json-panel').classList.add('hidden');
  document.getElementById('section-preview').classList.add('hidden');
  document.getElementById('preview-btn').classList.remove('active');
  showAlert(`Parsed ${data.days.length} days from "${data.title}"`, 'success');
}

function handleCSVText(text) {
  pendingCSVText = text;
  const wrap = document.getElementById('parse-chooser-wrap');
  wrap.classList.remove('hidden');
  wrap.querySelector('.parse-chooser').classList.remove('hidden');
  document.getElementById('parse-loading').classList.add('hidden');
  wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function scriptParse() {
  if (!pendingCSVText) return;
  document.getElementById('parse-chooser-wrap').classList.add('hidden');
  try {
    const rows = parseCSV(pendingCSVText);
    const data = parsePrayerData(rows);
    loadData(data);
  } catch (err) {
    showAlert(`Parse error: ${err.message}`, 'error');
    console.error(err);
  }
}

async function aiParse() {
  if (!pendingCSVText) return;
  const wrap = document.getElementById('parse-chooser-wrap');
  const loading = document.getElementById('parse-loading');
  const chooser = wrap.querySelector('.parse-chooser');
  chooser.classList.add('hidden');
  loading.classList.remove('hidden');
  try {
    const resp = await fetch('/api/ai-parse', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ csv: pendingCSVText }),
    });
    if (!resp.ok) {
      const err = await resp.json().catch(() => ({ error: 'unknown' }));
      throw new Error(err.error || `Server error ${resp.status}`);
    }
    const data = await resp.json();
    wrap.classList.add('hidden');
    loadData(data);
    showAlert(`AI parsed ${data.days.length} days from "${data.title}"`, 'success');
  } catch (err) {
    loading.classList.add('hidden');
    chooser.classList.remove('hidden');
    showAlert(`AI parse failed: ${err.message}`, 'error');
    console.error(err);
  }
}

// ─────────────────────────────────────────────
// SCHEDULED NOTIFICATIONS (QUEUE)
// ─────────────────────────────────────────────

function groupByDay(queue) {
  const map = new Map();
  for (const n of queue) {
    const key = n.gregFull || n.fireUTC?.slice(0, 10) || 'Unknown';
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(n);
  }
  return map;
}

function renderScheduled(queue) {
  const list = document.getElementById('sched-list');
  const countEl = document.getElementById('sched-count');
  const nowISO = new Date().toISOString();

  if (!queue || queue.length === 0) {
    countEl.textContent = '0 notifications in queue';
    list.innerHTML = `<div class="sched-empty">No notifications scheduled yet.<br><small style="color:#333;margin-top:4px;display:block;">Upload a CSV and push to NTFY to schedule.</small></div>`;
    return;
  }

  const upcomingCount = queue.filter(n => (n.fireUTC || '') > nowISO).length;
  const pastCount = queue.length - upcomingCount;
  countEl.textContent = `${queue.length} total \u00b7 ${upcomingCount} scheduled \u00b7 ${pastCount} fired`;

  const grouped = groupByDay(queue);
  list.innerHTML = '';

  for (const [dayLabel, notifs] of grouped) {
    const firstUTC = notifs[0]?.fireUTC || '';
    const isPast = firstUTC && firstUTC <= nowISO;
    const stateClass = isPast ? 'past' : 'upcoming';
    const stateLabel = isPast ? 'Fired' : 'Scheduled';

    const dayDiv = document.createElement('div');
    dayDiv.className = `sched-day ${stateClass}`;

    const header = document.createElement('div');
    header.className = 'sched-day-header';
    header.innerHTML = `
      <div class="status-dot ${stateClass}"></div>
      <div class="sched-day-label">${dayLabel}</div>
      <div class="sched-day-meta">${notifs.length} notifications \u00b7 ${stateLabel}</div>
      <div class="sched-day-chevron">\u25b6</div>
    `;

    const body = document.createElement('div');
    body.className = 'sched-day-body';

    for (const n of notifs) {
      const row = document.createElement('div');
      row.className = 'sched-notif-row';
      const msgLines = [n.details, n.countdown].filter(Boolean).join(' \u00b7 ');
      row.innerHTML = `
        <div class="sched-notif-icon">${n.icon || ''}</div>
        <div class="sched-notif-info">
          <div class="sched-notif-title">${n.title}</div>
          ${msgLines ? `<div class="sched-notif-detail">${msgLines}</div>` : ''}
        </div>
        <div class="sched-notif-time">
          ${n.fireTimeFmt || '\u2014'}
          <span class="utc">${n.fireUTC ? new Date(n.fireUTC).toISOString().slice(0,16).replace('T',' ') + ' UTC' : ''}</span>
        </div>
      `;
      body.appendChild(row);
    }

    header.addEventListener('click', () => dayDiv.classList.toggle('open'));
    dayDiv.appendChild(header);
    dayDiv.appendChild(body);
    list.appendChild(dayDiv);
  }
}

async function fetchAndRenderQueue() {
  try {
    const resp = await fetch('/api/queue');
    if (!resp.ok) throw new Error('Failed to load queue');
    const queue = await resp.json();
    renderScheduled(queue);
  } catch (e) {
    document.getElementById('sched-count').textContent = 'Error loading queue';
    console.error(e);
  }
}

// ─────────────────────────────────────────────
// EVENT WIRING
// ─────────────────────────────────────────────

const fileInput = document.getElementById('csv-file');
const dropZone = document.getElementById('drop-zone');

dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { markAccepted(file.name); handleCSVText(ev.target.result); };
  reader.readAsText(file);
});

dropZone.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
dropZone.addEventListener('drop', e => {
  e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => { markAccepted(file.name); handleCSVText(ev.target.result); };
  reader.readAsText(file);
});

function markAccepted(filename) {
  dropZone.classList.add('accepted');
  dropZone.querySelector('.upload-icon').textContent = '';
  dropZone.querySelector('h2').textContent = filename;
  dropZone.querySelector('p').textContent = 'File loaded \u2014 choose a parse method below';
}

function resetDropZone() {
  dropZone.classList.remove('accepted');
  dropZone.querySelector('.upload-icon').textContent = '';
  dropZone.querySelector('h2').textContent = 'Drop your prayer times CSV here';
  dropZone.querySelector('p').textContent = 'or click to browse';
}

document.getElementById('paste-toggle').addEventListener('click', () => {
  document.getElementById('paste-area').classList.toggle('hidden');
});

document.getElementById('parse-paste-btn').addEventListener('click', () => {
  const text = document.getElementById('csv-paste').value;
  if (!text.trim()) { showAlert('Nothing pasted yet.', 'error'); return; }
  markAccepted('Pasted CSV');
  handleCSVText(text);
});

// Clear
document.getElementById('clear-btn').addEventListener('click', () => {
  parsedData = null; pendingCSVText = null;
  document.getElementById('data-area').classList.add('hidden');
  document.getElementById('parse-chooser-wrap').classList.add('hidden');
  document.getElementById('csv-file').value = '';
  document.getElementById('csv-paste').value = '';
  resetDropZone();
});

// Preview — toggle inline below
document.getElementById('preview-btn').addEventListener('click', () => {
  if (!parsedData) return;
  const section = document.getElementById('section-preview');
  const btn = document.getElementById('preview-btn');
  if (!section.classList.contains('hidden')) {
    section.classList.add('hidden');
    btn.classList.remove('active');
    return;
  }
  previewFilter = 'all';
  previewPage = 0;
  renderDayFilterTabs();
  renderPreviewPage();
  section.classList.remove('hidden');
  btn.classList.add('active');
  section.scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// Preview pagination
document.getElementById('preview-prev').addEventListener('click', () => { previewPage--; renderPreviewPage(); });
document.getElementById('preview-next').addEventListener('click', () => { previewPage++; renderPreviewPage(); });

// Raw JSON
document.getElementById('raw-btn').addEventListener('click', () => {
  if (!parsedData) return;
  const panel = document.getElementById('raw-json-panel');
  const content = document.getElementById('raw-json-content');
  if (panel.classList.contains('hidden')) {
    content.textContent = JSON.stringify(parsedData, null, 2);
    panel.classList.remove('hidden');
  } else {
    panel.classList.add('hidden');
  }
});

// Schedule — save to queue, server fires at the right time
document.getElementById('push-ntfy-btn').addEventListener('click', async () => {
  if (!parsedData) { showAlert('No CSV loaded.', 'error'); return; }
  const btn = document.getElementById('push-ntfy-btn');
  btn.disabled = true; btn.textContent = 'Scheduling\u2026';

  try {
    const notifications = buildAllNotifications(parsedData);
    const valid = notifications.filter(n => n.fireUTC);
    if (valid.length === 0) { showAlert('No valid fire times found.', 'error'); return; }

    const resp = await fetch('/api/push', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(valid),
    });
    if (!resp.ok) throw new Error(`Server error ${resp.status}`);
    const result = await resp.json();

    const parts = [`${result.queued} scheduled`];
    if (result.skipped) parts.push(`${result.skipped} past skipped`);
    parts.push(`${result.pending} pending`);
    showAlert(parts.join(' \u00b7 '), 'success');

    // Refresh queue display
    await fetchAndRenderQueue();
  } catch (e) {
    showAlert(`Schedule failed: ${e.message}`, 'error');
    console.error(e);
  } finally {
    btn.disabled = false; btn.textContent = 'Schedule';
  }
});

// Delete future
document.getElementById('delete-future-btn').addEventListener('click', async () => {
  const btn = document.getElementById('delete-future-btn');
  btn.disabled = true; btn.textContent = 'Deleting\u2026';
  try {
    const resp = await fetch('/api/queue/future', { method: 'DELETE' });
    if (!resp.ok) throw new Error(`Server error ${resp.status}`);
    const result = await resp.json();
    showAlert(`Deleted ${result.deleted} future notifications. ${result.queue.length} past remain.`, 'success');
    await fetchAndRenderQueue();
  } catch (e) {
    showAlert(`Delete failed: ${e.message}`, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'Delete future';
  }
});

// Parse mode chooser
document.getElementById('parse-script').addEventListener('click', scriptParse);
document.getElementById('parse-ai').addEventListener('click', aiParse);

// Check AI availability on load
fetch('/api/ai-available').then(r => r.json()).then(d => {
  aiAvailable = d.available;
  if (aiAvailable) document.getElementById('parse-ai').classList.remove('hidden');
}).catch(() => {});

// Load queue immediately and poll every 15s to stay in sync across all users
fetchAndRenderQueue();
setInterval(fetchAndRenderQueue, 15000);
</script>
</body>
</html>
